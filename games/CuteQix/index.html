<html>
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>CuteQix</title>
	<link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
	<link rel="stylesheet" href="./main.css">
</head>

<script>
const CEL_HEIGHT = 10;
const GRID_ROWS = 60;
const GRID_COLS = 90;
const COVER_ZINDEX = 1000;
const PATH_ZINDEX = 1100;
const PLAYER_ZINDEX = 1200;
const SPARX_ZINDEX = 1300;
const QIX_ZINDEX = 1400;
const PAUSE_ZINDEX = 2000;
const ANIMATION_INTERVAL = 100;

var KEYS = [];
var IS_PAUSED = false;

var PLAYER_TAIL = [];

function TileType(_type, _img) {
	this.type = _type;
	this.img = _img;
}

const _EMPTY = "EMPTY";
const EMPTY = new TileType(_EMPTY, "./img/dark_tile.png");

const _PATH = "PATH";
const PATH = new TileType(_PATH, "./img/white_tile.png");

const _PUSH = "PUSH";
const PUSH = new TileType(_PUSH, "./img/gray_tile.png");

const _CLAIM = "CLAIM";
const CLAIM = new TileType(_CLAIM, "./img/empty_tile.png");

const _DEADPATH = "DEADPATH";
const DEADPATH = new TileType(_DEADPATH, "./img/semi_tile.png");

function LevelImg(_revealed, _maxPercentage) {
	this.revealed = _revealed;
	this.maxPercentage = _maxPercentage;
	this.isRevealed = function() { return this.revealed; }
	this.setMaxPercentage = function(_revealedPercent) {
		if (_revealedPercent > this.maxPercentage) {
			this.maxPercentage = _revealedPercent;
		}
	}
}

function Cute(_id, _name, _fromGame, _toUnlock, _info1, _info2, _info3) {
	this.id = _id;
	this.name = _name;
	this.fromGame = _fromGame;
	this.toUnlock = _toUnlock;
	this.img = "./img/cute_head_" + this.id + ".webp";
	this.levelImgs = [];
	this.levelImgs[0] = new LevelImg(false, 0);
	this.levelImgs[1] = new LevelImg(false, 0);
	this.levelImgs[2] = new LevelImg(false, 0);
	this.info = [];
	this.info[0] = _info1;
	this.info[1] = _info2;
	this.info[2] = _info3;
	this.getTitle = function() { return this.name + "\r\n(" + this.fromGame + ")"; }
	this.getLevelImg = function(_level) { return this.levelImgs[_level - 1]; }
	this.getInfo = function(_level) { return this.info[_level - 1]; }
}

function Cutes() {
	this.selectedCute = -1;
	this.cutes = [];
	this.push = function(_cute) { this.cutes.push(_cute); }
	this.getSelectedCute = function() {
		if (this.selectedCute == -1) {
			return null;
		} else {
			return this.cutes[this.selectedCute];
		}
	}
}
var CUTES = new Cutes();
CUTES.push(new Cute("001", "Miniature Shnauzer", "Dog", 0, "Miniature Schnauzers are friendly, smart, and obedient", "Miniature Schnauzers should be groomed every six weeks", "Miniature Schnauzers are known for their distinctive beards and eyebrows"));
CUTES.push(new Cute("002", "Persian", "Cat", 0, "Persian Cats are very friendly and affectionate, and they love to be around people", "Persian Cats are not a very high-energy breed and are known for being lazy", "Persian Cats have a unique appearance with their flat faces and thick, long, silky coats"));
CUTES.push(new Cute("003", "Hedgehog", "Hedgehog", 0, "Hedgehogs have poor eyesight but good hearing and a well-developed sense of smell", "Hedgehogs are good runners, proficient climbers, and can even swim", "Hedgehogs roll into a ball to protect themselves from predators"));
CUTES.push(new Cute("004", "Baby Tiger", "Tiger", 0, "Tigers are born with no teeth, although fully grown tigers have 30 teeth and very strong jaws", "A group of tigers is called a streak", "Tiger cubs begin eating meat at anywhere from 6 to 8 weeks old"));
CUTES.push(new Cute("005", "Baby Seal", "Seal", 3, "Baby seals can grow up to be the size of a car", "Baby Seals have a layer of fat called blubber that protects them from the cold", "When baby seals are born, they can barely swim"));
CUTES.push(new Cute("006", "Baby Elephant", "Elephant", 5, "Baby Elephants can stand up and walk within a few hours of being born", "Nearly all Baby Elephants are born at night", "Baby Elephants can drink around 3 gallons of milk a day from their mother"));
CUTES.push(new Cute("007", "Baby Giraffe", "Giraffe", 7, "Baby giraffes are able to sleep standing up", "Baby giraffes are around 6 feet tall when born", "Baby giraffes are able to run within hours of being born"));
CUTES.push(new Cute("008", "Duckling", "Duck", 9, "Ducklings walk in groups for protection", "A group of ducks is called a flock", "Ducklings spend 60% of their day eating"));
CUTES.push(new Cute("009", "Ferret", "Ferret", 11, "Ferrets are playful and curious animals that love to explore their surroundings", "Ferrets are very social animals and should be kept in pairs or groups", "A group of ferrets is called a 'business'"));
CUTES.push(new Cute("010", "Baby Koala", "Koala", 13, "Koalas are marsupials, which means they carry their young in a pouch", "Baby Koalas are born blind, deaf, and hairless", "Newborn Baby Koalas are incredibly tiny and vulnerable"));
CUTES.push(new Cute("011", "Baby Sloth", "Sloth", 15, "Baby Sloths are born with fur, eyes open, and able to climb", "A Baby Sloth weighs about 10 ounces when born", "Sloths may live their entire lives in one tree"));
CUTES.push(new Cute("012", "Owl", "Owl", 17, "A group of owls is called a 'parliament'", "Owls have large eyes and a flat face", "Owls are active at night (nocturnal)"));
CUTES.push(new Cute("013", "Baby Capybara", "Capybara", 19, "Capybara are herbivores and feed on grasses, aquatic plants, and fruits", "Baby Capybaras are born with their eyes open and can walk within a few hours of being born", "Capybaras are the largest rodents in the world"));
CUTES.push(new Cute("014", "Suricate", "Suricate", 21, "Suricates are known for their upright posture and curious nature", "Suricates are omnivores and feed on a variety of insects, small mammals, and plants", "Suricates are very social animals and live in groups called mobs or gangs"));
CUTES.push(new Cute("015", "Axolotl", "Axolotl", 23, "Axolotls have a lifespan of around 10-15 years", "Axolotls are popular pets and are bred in captivity for this purpose", "Axolotls have the ability to regenerate lost body parts, including limbs, spinal cord and heart"));
CUTES.push(new Cute("016", "Squirrel", "Squirrel", 25, "Squirrels are very agile and can jump up to 10 times their body length", "A group of squirrels is called a scurry or dray", "Squirrels are able to run up to 20 miles per hour"));
CUTES.push(new Cute("017", "Hummingbird", "Hummingbird", 27, "Hummingbirds are the smallest birds in the world", "Hummingbirds are the only birds that can fly in different directions", "Hummingbirds possess long beaks that can easily sip out the nectar at the bottom of the flower"));
CUTES.push(new Cute("018", "Fennec Fox", "Fennec Fox", 29, "Fennec Foxes are the smallest foxes in the world", "Fennec Foxes have huge bat-like ears that can be up to half the size of their bodies", "Fennec Foxes live in dens underground which they dig out using their feet"));
CUTES.push(new Cute("019", "Baby Panda", "Giant Panda", 31, "Baby pandas are born pink and hairless, weighing only about 100 grams", "Baby pandas are able to climb trees before they can even walk", "Baby pandas are born with a toothless grin and start growing teeth at around 3 months old"));
CUTES.push(new Cute("020", "Baby Red Panda", "Red Panda", 33, "Red Pandas are not related to Giant Pandas", "They are known for their playful behavior and are often seen rolling around and playing with objects", "Red Pandas are primarily herbivores and feed on bamboo, fruits, and berries"));
CUTES.push(new Cute("021", "Seahorse", "Seahorse", 35, "Seahorses have big appetites and are constantly eating plankton, plants, tiny fish, and brine shrimp", "Seahorses are solitary animals and prefer to swim in pairs with their tails linked together", "Seahorses hold a world-record for being the slowest swimmers in the ocean"));
CUTES.push(new Cute("022", "Dolphin", "Dolphin", 37, "Dolphins are known to be playful and curious animals", "Bottlenose Dolphins sleep with one half of their brain at a time, and keep one eye open", "Dolphins can swim at speeds of over 30 mph for brief periods"));
CUTES.push(new Cute("023", "Baby Otter", "Otter", 39, "Baby Otters are blind and incredibly tiny when they are born", "Baby Otters have thick fur that keeps them warm in cold water", "Otter families work together to raise babies"));
CUTES.push(new Cute("024", "Pygmy Marmoset", "Monkey", 41, "Pygmy Marmosets are the smallest true monkey", "The Pygmy Marmosets reside in the rainforests of South America", "The Pygmy Marmosets have the incredible ability to leap up to 15 feet between trees"));
CUTES.push(new Cute("025", "Flamingo", "Flamingo", 43, "Flamingos are not born pink. It takes about three years for their feathers to turn pink and red", "A group of Flamingos is called a flamboyance", "Flamingos can live up to 60 years in the wild"));
CUTES.push(new Cute("026", "Golden Lion Tamarin", "Monkey", 45, "They have a distinctive golden-orange fur and a long, mane-like hair around their face", "They are omnivorous and eat fruit, insects, and small lizards", "They move their nest frequently to avoid predators and parasites"));
CUTES.push(new Cute("027", "Toucan", "Toucan", 47, "Toucans have the largest bill-to-body ratio of any bird in the world", "Toucans use their bills to reach for fruits, peel them, and regulate their body temperature", "Toucans are social birds and often live in flocks of up to 20 individuals"));
CUTES.push(new Cute("028", "Armadillo", "Armadillo", 49, "Armadillos are timid creatures and will often retreat to their burrows when they feel threatened", "Armadillo shells are composed of bony plates covered in scales", "Armadillos are known for their armored bodies and their ability to curl up into tight balls to defend themselves from predators"));
CUTES.push(new Cute("029", "Hyacinth Macaw", "Parrot", 51, "Hyacinth Macaws are the largest parrots in the world", "They are completely blue except for some bright yellow parts located around their eyes and a small area just below their beak", "They have a lifespan of 50-60 years"));
CUTES.push(new Cute("030", "Baby Rabbit", "Rabbit", 53, "Baby Rabbits are born naked, deaf and blind, with closed eyes and ears", "Baby Rabbits open their eyes 10 to 14 days after birth", "Baby rabbits are very social and like to interact with their owners and other rabbits"));
CUTES.push(new Cute("031", "Baby Llama", "Llama", 55, "Llamas are members of the camelid family, meaning they are related to camels and alpacas", "Llamas are very intelligent and can learn how to navigate obstacle courses with ease", "Llamas can hum when they are happy and spit when they are angry or threatened"));
CUTES.push(new Cute("032", "Raccoon", "Raccoon", 57, "Raccoons have surprisingly good night vision", "Urban Raccoons are smarter than their rural counterparts", "Raccoons live for up to 2-3 years in the wild and up to 20 years in captivity"));
CUTES.push(new Cute("033", "Tarsier", "Tarsier", 59, "Tarsiers have the largest eyes relative to body size of any mammal", "Tarsier babies are the largest relative to the size of the mother of any mammal", "Tarsiers can jump 40 times their body length in a single leap"));

/*
CUTES.push(new Cute("034", "Gecko", "Gecko", 59, "", "", ""));
CUTES.push(new Cute("035", "Penguin", "Penguin", 61, "", "", ""));
CUTES.push(new Cute("036", "Kangaroo", "Kangaroo", 65, "", "", ""));
CUTES.push(new Cute("037", "Zebra", "Zebra", 67, "", "", ""));
CUTES.push(new Cute("038", "Baby Pig", "Pig", 69, "", "", ""));
CUTES.push(new Cute("039", "Baby Turtle", "Turtle", 69, "", "", ""));
CUTES.push(new Cute("040", "Baby Deer", "Deer", 71, "", "", ""));
CUTES.push(new Cute("041", "Baby Gorilla", "Gorilla", 73, "", "", ""));
CUTES.push(new Cute("042", "Baby Chameleon", "Chameleon", 75, "", "", ""));
CUTES.push(new Cute("043", "Baby Hippo", "Hippopotamus", 77, "", "", ""));
*/

CUTES.selectedCute = 0;

function Avatar(_id, _name, _fromGame, _toUnlock) {
	this.id = _id;
	this.name = _name;
	this.fromGame = _fromGame;
	this.toUnlock = _toUnlock;
	this.img = "./img/player_head_" + this.id + ".webp";
	this.getTitle = function() { return this.name + "\r\n(" + this.fromGame + ")"; }
}

function Avatars() {
	this.selectedAvatar = -1;
	this.avatars = [];
	this.push = function(_avatar) { this.avatars.push(_avatar); }
	this.getSelectedAvatar = function() {
		if (this.selectedAvatar == -1) {
			return null;
		} else {
			return this.avatars[this.selectedAvatar];
		}
	}
}
var AVATARS = new Avatars();

AVATARS.push(new Avatar("001", "Alan", "Veterinarian", 0));
AVATARS.push(new Avatar("002", "Amara", "Medical Doctor", 0));
AVATARS.push(new Avatar("003", "Michael", "Astronaut", 0));
AVATARS.push(new Avatar("004", "Mila", "Teacher", 0));
AVATARS.push(new Avatar("005", "Rupert", "Clown", 9));
AVATARS.push(new Avatar("006", "RVT-303", "Robot", 18));
AVATARS.push(new Avatar("007", "Sam", "Cartoon", 27));
AVATARS.push(new Avatar("008", "Sylvia", "Cartoon", 27));
AVATARS.push(new Avatar("009", "Xael", "Jello", 33));
AVATARS.push(new Avatar("010", "Robin", "Ghost", 39));
AVATARS.push(new Avatar("011", "Trics", "Triceratops", 45));
AVATARS.push(new Avatar("012", "Ixvy", "Alien", 51));

AVATARS.selectedAvatar = 0;

var IMAGES_REVEALED = 0;


function Level(_cuteImg, _goal) {
	this.cuteImg = _cuteImg;
	this.goal = _goal;
}

function Levels(_avatar, _cute) {
	this.avatar = _avatar;
	this.cute = _cute;
	this.level = 1;
	this.finished = false;
	this.levels = [
		new Level("./img/cute_" + this.cute.id + "-01.webp", 60),
		new Level("./img/cute_" + this.cute.id + "-02.webp", 70),
		new Level("./img/cute_" + this.cute.id + "-03.webp", 80)
	];
	this.getCurrentLevel = function() { return this.levels[this.level - 1]; }
	this.nextLevel = function() {
		if (this.level >= this.levels.length) {
			this.finished = true;
		} else {
			this.level++; 
		}
	}
	this.getAvatarImg = function() { return this.avatar.img; }
	this.getCuteHead = function() { return this.cute.img; }
}

function Tile(_x, _y, _pixels, _row, _col, _tileType) {
	this.x = _x;
	this.y = _y;
	this.pixels = _pixels;
	this.row = _row;
	this.col = _col;
	this.tileType = _tileType;
	this.hasQix = false;
	this.hasSparx = false;
	this.hasPlayer = false;
	this.hasPush = false;
}

function Grid(_x, _y, _rows, _columns, _tileSize) {
	this.rows = _rows;
	this.columns = _columns;
	this.map = [];
	this.inGrid = function(_row, _col) { return _row >= 0 && _row < this.rows && _col >= 0 && _col < this.columns; }

	for (row = 0; row < this.rows; row++) {
		this.map[row] = [];
		for (col = 0; col < this.columns; col++) {
			_tileType = EMPTY;
			//_tileType = CLAIM;
			//_tileType = DEADPATH;

			// the border of the initial grid must be set as PATH
			// first row, first column, last row and last column
			if (row == 0 || col == 0 || row == (this.rows - 1) || col == (this.columns - 1)) {
				_tileType = PATH;
			}

			this.map[row][col] = new Tile(col * _tileSize + _x, row * _tileSize + _y, _tileSize, row, col, _tileType);
		}
	}
}
var GRID = new Grid(0, 0, GRID_ROWS, GRID_COLS, CEL_HEIGHT);


function newImage(src, height, position, top, left, zIndex, alt) {
	var img = new Image();
	img.src = src;
	img.height = height;
	img.style.position = position;
	img.style.top = top;
	img.style.left = left;
	img.style.zIndex = zIndex;
	img.alt = alt;
	return img;
}

var IS_GAME_OVER = false;
var GAME_OVER_IMG = newImage("./img/game_over_img.webp", 600, "relative", 0, 0, 1, "Game Over");
function gameOver() {
	IS_GAME_OVER = true;
	var td = document.getElementById("td_game");
	td.replaceChildren();
	td.appendChild(GAME_OVER_IMG);
}

var PAUSED_IMG = newImage("./img/paused2.png", 400, "absolute", (((GRID_ROWS * CEL_HEIGHT) / 2) - (400 / 2) - 10), (((GRID_COLS * CEL_HEIGHT) / 2) - (450 / 2)), PAUSE_ZINDEX, "Game Paused");
PAUSED_IMG.id = "PausedImgModal";
PAUSED_IMG.style.visibility = "hidden";

var NEXT_LEVEL_IMG = newImage("./img/level_complete.png", 165, "absolute", (((GRID_ROWS * CEL_HEIGHT) / 2) - (165 / 2) - 10), (((GRID_COLS * CEL_HEIGHT) / 2) - (400 / 2)), PAUSE_ZINDEX, "Next Level");
NEXT_LEVEL_IMG.id = "NextLevelImgModal";
NEXT_LEVEL_IMG.style.visibility = "hidden";


function removeImmunity() {
	PLAYER.isImmune = false;
}

function Player(_tile) {
	this.tile = _tile;
	GRID.map[_tile.row][_tile.col].hasPlayer = true;
	this.images = ["./img/player_00.png", "./img/player_01.png"];
	this.imgIdx = 0;
	this.img = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, PLAYER_ZINDEX, "Player");
	this.img.id = "player_img";
	this.isClaiming = false;
	this.lives = 10;
	this.isImmune = false;
	this.immuneUntil = new Date();

	this.hit = function() {
		if (this.isImmune) {
			return;
		}
		this.lives--;
		updateLives(this.lives);
		if (this.lives > 0) {
			this.isImmune = true;
			var t = new Date();
			t.setSeconds(t.getSeconds() + 3);
			this.immuneUntil = t;
		} else {
			gameOver();
		}
	}
	this.getTile = function() { return this.tile; }
	this.hide = function() { this.img.style.visibility = "hidden"; }
	this.show = function() { this.img.style.visibility = "visible"; }
	this.setTile = function(_curr) {
		if (GRID.inGrid(_curr.row, _curr.col)) {
			GRID.map[this.tile.row][this.tile.col].hasPlayer = false;
			this.tile = _curr
			GRID.map[_curr.row][_curr.col].hasPlayer = true;
			this.img.style.top = _curr.y;
			this.img.style.left = _curr.x;
			if (this.tile.hasSparx || this.tile.hasQix) {
				this.hit();
			}
		}
	}
	this.nextImg = function() {
		this.imgIdx++;
		if (this.imgIdx >= this.images.length) {
			this.imgIdx = 0;
		}
		this.img.src = this.images[this.imgIdx];
		var staticPlayer = document.getElementById("staticPlayer");
		staticPlayer.src = this.images[this.imgIdx];
		if (this.isImmune) {
			// if paused, keep extending the immunity
			if (IS_PAUSED) {
				this.immuneUntil = new Date(this.immuneUntil.getTime() + ANIMATION_INTERVAL);
			}

			if (this.immuneUntil < new Date()) {
				this.isImmune = false;
				this.img.style.filter = "invert(0)";
				staticPlayer.style.filter = "invert(0)";
			} else {
				this.img.style.filter = "invert(100)";
				staticPlayer.style.filter = "invert(100)";
			}
		}
	}
}

var PLAYER = new Player(GRID.map[GRID.rows - 1][GRID.columns / 2]);
function playerNextImg() {
	PLAYER.nextImg();
}
window.setInterval(playerNextImg, ANIMATION_INTERVAL);

function tailPop() {
	var t = PLAYER_TAIL.pop();
	if (PLAYER_TAIL.length == 0) {
		t.tileType = PATH;
	} else {
		t.tileType = EMPTY;
	}
	var img = document.getElementById("img_" + t.row + "_" + t.col);
	img.src = t.tileType.img;

	PLAYER.setTile(t);
}

async function breakPlayerTail() {
	wasPushing = false;
	IS_PAUSED = true;
	PLAYER.hit();

	while (PLAYER_TAIL.length > 0) {
		tailPop();
		await new Promise(resolve => setTimeout(resolve, 5));
	}

	IS_PAUSED = false;
}

function Qix(_tile) {
	this.tile = _tile;
	this.mid = _tile;
	this.tail = _tile;
	GRID.map[_tile.row][_tile.col].hasQix = true;
	this.images = ["./img/qix_00.png", "./img/qix_01.png", "./img/qix_02.png"];
	this.imgIdx = 0;
	this.img = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, QIX_ZINDEX, "Qix");
	this.img.id = "qix_img";
	this.imgMid = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, QIX_ZINDEX, "Qix");
	this.imgMid.id = "qix_img_mid";
	this.imgTail = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, QIX_ZINDEX, "Qix");
	this.imgTail.id = "qix_img_tail";
	this.velX = 0;
	this.velY = 0;
	this.tickCounter = 0;

	this.getTile = function() { return this.tile; }
	this.setTile = function(_curr) {
		if (GRID.inGrid(_curr.row, _curr.col)) {
			GRID.map[this.tile.row][this.tile.col].hasQix = false;
			this.tail = this.mid;
			this.mid = this.tile;
			this.tile = _curr
			GRID.map[_curr.row][_curr.col].hasQix = true;
			this.img.style.top = _curr.y;
			this.img.style.left = _curr.x;
			this.imgMid.style.top = this.mid.y;
			this.imgMid.style.left = this.mid.x;
			this.imgTail.style.top = this.tail.y;
			this.imgTail.style.left = this.tail.x;
		}
	}
	this.show = function() {
		this.img.style.visibility = "visible";
		this.imgMid.style.visibility = "visible";
		this.imgTail.style.visibility = "visible";
	}
	this.hide = function() {
		this.img.style.visibility = "hidden";
		this.imgMid.style.visibility = "hidden";
		this.imgTail.style.visibility = "hidden";
	}
	this.nextImg = function() {
		this.imgIdx++;
		if (this.imgIdx >= this.images.length) {
			this.imgIdx = 0;
		}
		this.img.src = this.images[this.imgIdx];
		document.getElementById("staticQix").src = this.images[this.imgIdx];
		this.imgMid.src = this.images[this.imgIdx];
		this.imgTail.src = this.images[this.imgIdx];
	}
	this.move = function() {
		if (IS_PAUSED || IS_GAME_OVER) {
			return;
		}
		this.tickCounter++;
		if (this.tickCounter >= 10) {
			this.tickCounter = 0;
			switch (Math.floor(Math.random() * 7)) {
				case 0: this.velX = 1; this.velY = 0; break;
				case 1: this.velX = -1; this.velY = 0; break;
				case 2: this.velX = 0; this.velY = 1; break;
				case 3: this.velX = 0; this.velY = -1; break;
				case 4: this.velX = 1; this.velY = 1; break;
				case 5: this.velX = -1; this.velY = -1; break;
				case 6: this.velX = 1; this.velY = -1; break;
				default: this.velX = -1; this.velY = 1;
			}
		}
		var newRow = this.tile.row + this.velY;
		var newCol = this.tile.col + this.velX;
		if (GRID.inGrid(newRow, newCol)) {
			var newTile = GRID.map[newRow][newCol];
			if (newTile.tileType != PATH) {
				this.setTile(newTile);
				if (this.getTile().tileType == PUSH) {
					breakPlayerTail();
				}
			} else {
				this.velY *= -1;
				this.velX *= -1;
				newRow = this.tile.row + this.velY;
				newCol = this.tile.col + this.velX;
				newTile = GRID.map[newRow][newCol];
				if (newTile.tileType != PATH) {
					this.setTile(newTile);
				}
			}
		}
	}
}

var QIX = new Qix(GRID.map[GRID.rows / 2][GRID.columns / 2]);
function qixMove() {
	QIX.nextImg();
	QIX.move();
}
window.setInterval(qixMove, ANIMATION_INTERVAL / 3);


function Sparx(_tile, _clockwise) {
	this.tile = _tile;
	this.prev = _tile;
	this.clockwise = _clockwise;
	GRID.map[_tile.row][_tile.col].hasSparx = true;
	this.images = ["./img/sparx_00.png", "./img/sparx_01.png"];
	this.imgIdx = 0;
	this.img = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, SPARX_ZINDEX, "Sparx");
	this.img.id = "sparx_img";
	this.canMove = false;

	this.getTile = function() { return this.tile; }
	this.setTile = function(_curr) {
		if (GRID.inGrid(_curr.row, _curr.col)) {
			GRID.map[this.tile.row][this.tile.col].hasSparx = false;
			this.prev = this.tile
			this.tile = _curr
			GRID.map[_curr.row][_curr.col].hasSparx = true;
			this.img.style.top = _curr.y;
			this.img.style.left = _curr.x; 
		}
	}
	this.hide = function() { this.img.style.visibility = "hidden"; }
	this.show = function() { this.img.style.visibility = "visible"; }
	this.nextImg = function() {
		this.imgIdx++;
		if (this.imgIdx >= this.images.length) {
			this.imgIdx = 0;
		}
		this.img.src = this.images[this.imgIdx];
		document.getElementById("staticSparx").src = this.images[this.imgIdx];
	}
	this.move = function() {
		if (IS_PAUSED || IS_GAME_OVER) {
			return;
		}
		if (this.canMove) {
			// if first move
			if (this.prev.row == this.tile.row && this.prev.col == this.tile.col) {
				if (this.clockwise) {
					if (this.tile.row == 0) {
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (this.tile.col == 0) {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					}
				} else {
					if (this.tile.row == 0) {
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (this.tile.col == 0) {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					}
				}
			} else {
				// not first move
				if ((this.tile.col - this.prev.col) > 0) { // left to right
					if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == PATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == PATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == DEADPATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == DEADPATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					}
				} else if ((this.tile.row - this.prev.row) > 0) { // up to down
					if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == PATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == PATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == DEADPATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == DEADPATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					}
				} else if ((this.tile.col - this.prev.col) < 0) { // right to left
					if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == PATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == PATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == DEADPATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == DEADPATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					}
				} else { // down to up
					if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == PATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == PATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == DEADPATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == DEADPATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					}
				}
			}
		}
		if (this.getTile().hasPlayer) {
			PLAYER.hit();
		}
		this.canMove = !this.canMove;
	}
}

var SPARX1 = new Sparx(GRID.map[0][Math.floor(Math.random() * (GRID.columns - 2))], (Math.floor(Math.random() * 10) > 5) ? true : false);
var SPARX2 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][0], (Math.floor(Math.random() * 10) > 5) ? true : false);
var SPARX3 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][GRID.columns - 1], (Math.floor(Math.random() * 10) > 5) ? true : false);
//var sparxList = [SPARX1];
var sparxList = [SPARX1, SPARX2, SPARX3];
function sparxMove() {
	for (i = 0; i < sparxList.length; i++) {
		sparxList[i].nextImg();
		sparxList[i].move();
	}
}
window.setInterval(sparxMove, ANIMATION_INTERVAL * 1.0);


function pushIfEmpty(_row, _col) {
	if (GRID.map[_row][_col].tileType == EMPTY) {
		GRID.map[_row][_col].tileType = PUSH;
		var img = document.getElementById("img_" + _row + "_" + _col);
		img.src = PUSH.img;
		return true;
	}
	return false;
}

var VEL_L = 0;
var VEL_R = 0;
var VEL_U = 0;
var VEL_D = 0;

function unclaim(_tile) {
	var tiles = [];
	tiles.push(_tile);
	
	while (tiles.length > 0) {
		var t = tiles.pop();
		if (t.tileType == CLAIM) {
			t.tileType = EMPTY;
			if (GRID.inGrid(t.row + 1, t.col)) {
				tiles.push(GRID.map[t.row + 1][t.col]);
			}
			if (GRID.inGrid(t.row - 1, t.col)) {
				tiles.push(GRID.map[t.row - 1][t.col]);
			}
			if (GRID.inGrid(t.row, t.col + 1)) {
				tiles.push(GRID.map[t.row][t.col + 1]);
			}
			if (GRID.inGrid(t.row, t.col - 1)) {
				tiles.push(GRID.map[t.row][t.col - 1]);
			}

			if (GRID.inGrid(t.row + 1, t.col + 1)) {
				tiles.push(GRID.map[t.row + 1][t.col + 1]);
			}
			if (GRID.inGrid(t.row - 1, t.col + 1)) {
				tiles.push(GRID.map[t.row - 1][t.col + 1]);
			}
			if (GRID.inGrid(t.row + 1, t.col - 1)) {
				tiles.push(GRID.map[t.row + 1][t.col - 1]);
			}
			if (GRID.inGrid(t.row - 1, t.col - 1)) {
				tiles.push(GRID.map[t.row - 1][t.col - 1]);
			}
		} else if (t.tileType == DEADPATH) {
			t.tileType = PATH;
		}
	}
}

function updateGrid() {
	for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
		for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
			var img = document.getElementById("img_" + rowIdx + "_" + colIdx);
			img.src = GRID.map[rowIdx][colIdx].tileType.img;
		}
	}
}


function countEmpty() {
	var count = 0;
	for (var i = 0; i < GRID_ROWS; i++) {
		for (var j = 0; j < GRID_COLS; j++) {
			if (GRID.map[i][j].tileType == EMPTY || GRID.map[i][j].tileType == PATH) {
				count++;
			}
		}
	}
	return count;
}

function getClaimPercent() {
	return Math.floor((GRID_ROWS * GRID_COLS - countEmpty()) / (GRID_ROWS * GRID_COLS) * 100);
}

function updateLives(_lives) {
	document.getElementById("lives_text").textContent = _lives;
}

function updateLevel(_level) {
	document.getElementById("level_text").textContent = _level;
}

function getCuteLocalStorageKey(_cute, _level) {
	return "cute_" + _cute + "_" + _level;
}

function updateClaimedPercent(_claimed) {
	document.getElementById("claimed_text").textContent = _claimed;
	document.getElementById("myBar").style.width = _claimed + "%";
	document.getElementById("myBar").innerHTML = _claimed + "%";
	CUTES.getSelectedCute().getLevelImg(LEVELS.level).setMaxPercentage(_claimed);
	var lsMax = localStorage.getItem(getCuteLocalStorageKey(CUTES.getSelectedCute().id, LEVELS.level - 1) + "_max");
	if (lsMax < _claimed) {
		localStorage.setItem(getCuteLocalStorageKey(CUTES.getSelectedCute().id, LEVELS.level - 1) + "_max", _claimed);
	}
}

function updateGoal(_goal) {
	document.getElementById("goal_text").textContent = _goal;
	document.getElementById("myTarget").style.width = _goal + "%";
	document.getElementById("myTarget").innerHTML = _goal + "%";
}

async function clearGrid() {
	for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
		for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
			var img = document.getElementById("img_" + rowIdx + "_" + colIdx);
			img.src = CLAIM.img;
		}
		await new Promise(resolve => setTimeout(resolve, 20));
	}
}

function hideActors() {
	PLAYER.hide();
	QIX.hide();
	for (i = 0; i < sparxList.length; i++) {
		sparxList[i].hide();
	}
}

function showActors() {
	PLAYER.show();
	QIX.show();
	for (i = 0; i < sparxList.length; i++) {
		sparxList[i].show();
	}
}

var wasPushing = false;
async function claim() {
	for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
		for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
			if (GRID.map[rowIdx][colIdx].tileType == PATH || GRID.map[rowIdx][colIdx].tileType == PUSH) {
				GRID.map[rowIdx][colIdx].tileType = DEADPATH;
			} else if (GRID.map[rowIdx][colIdx].tileType == EMPTY) {
				GRID.map[rowIdx][colIdx].tileType = CLAIM;
			}
		}
	}
	unclaim(QIX.tile);
	updateGrid();
	var claimPercent = getClaimPercent();
	updateClaimedPercent(claimPercent);
	if (claimPercent >= LEVELS.getCurrentLevel().goal) {
		IS_PAUSED = true; 
		CUTES.getSelectedCute().getLevelImg(LEVELS.level).revealed = true;
		localStorage.setItem(getCuteLocalStorageKey(CUTES.getSelectedCute().id, LEVELS.level - 1) + "_rev", "Y");
		IMAGES_REVEALED++;
		LEVELS.nextLevel();
		hideActors();
		clearGrid();
		await new Promise(resolve => setTimeout(resolve, 5 * 1000)); // 5 seconds
		NEXT_LEVEL_IMG.style.visibility = "visible";
		await new Promise(resolve => setTimeout(resolve, 5 * 1000)); // 5 seconds
		showActors();
		if (LEVELS.finished) {
			displayCutes();
			cuteModal.style.display = "block";
		} else {
			loadLevel();
		}
	}
}

function movePlayer() {
	if (IS_PAUSED || IS_GAME_OVER) {
		return;
	}

	VEL_R = 0;
	if (KEYS[39] || KEYS[68]) { // 39 = right / 68 = "D"
		VEL_R = 1;
	}

	VEL_L = 0;
	if (KEYS[37] || KEYS[65]) { // 37 = left / 65 = "A"
		VEL_L = -1;
	}

	VEL_U = 0;
	if (KEYS[38] || KEYS[87]) { // 38 = up / 87 = "W"
		VEL_U = -1;
	}

	VEL_D = 0;
	if (KEYS[40] || KEYS[83]) { // 40 = down / 83 = "S"
		VEL_D = 1;
	}

	PLAYER.isClaiming = false;
	if (KEYS[32]) { // space key
		PLAYER.isClaiming = true;
	}

	if (wasPushing && !PLAYER.isClaiming) {
		tailPop();
		if (PLAYER_TAIL.length == 0) {
			wasPushing = false;
			return;
		}
		return;
	}

	if (VEL_L != 0 || VEL_R != 0 || VEL_U != 0 || VEL_D != 0) {
		if (GRID.inGrid(PLAYER.getTile().row + VEL_U + VEL_D, PLAYER.getTile().col + VEL_L + VEL_R)) {
			//console.log("PLAYER.isClaiming: " + PLAYER.isClaiming)
			if (PLAYER.isClaiming) {
				if (wasPushing && GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PATH) {
					PLAYER.isClaiming = false;
					wasPushing = false;
					PLAYER_TAIL = [];
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
					claim();
					return;
				}
				if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PUSH
					|| GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == CLAIM
					|| GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == DEADPATH) {
					return;
				}
				if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == EMPTY) {
					wasPushing = true;
				}
				if ((((VEL_L + VEL_R) > 0) && ((VEL_U + VEL_D) > 0)) || (((VEL_L + VEL_R) > 0) && ((VEL_U + VEL_D) < 0))) { // diagonal move -> (right and dowm) or (right and up)
					pushIfEmpty(PLAYER.getTile().row, PLAYER.getTile().col + VEL_L + VEL_R);
					PLAYER_TAIL.push(GRID.map[PLAYER.getTile().row][PLAYER.getTile().col + VEL_L + VEL_R]);
				} else if ((((VEL_L + VEL_R) < 0) && ((VEL_U + VEL_D) > 0)) || (((VEL_L + VEL_R) < 0) && ((VEL_U + VEL_D) < 0))) { // diagonal move -> (left and dowm) or (left and up)
					pushIfEmpty(PLAYER.getTile().row, PLAYER.getTile().col + VEL_L + VEL_R);
					PLAYER_TAIL.push(GRID.map[PLAYER.getTile().row][PLAYER.getTile().col + VEL_L + VEL_R]);
				}
				if (pushIfEmpty(PLAYER.getTile().row + VEL_U + VEL_D, PLAYER.getTile().col + VEL_L + VEL_R)) {
					if (PLAYER.getTile().tileType == PATH || PLAYER.getTile().tileType == EMPTY) {
						PLAYER_TAIL.push(PLAYER.getTile());
					}
					if (PLAYER.getTile().tileType == EMPTY) {
						pushIfEmpty(PLAYER.getTile().row, PLAYER.getTile().col);
					}
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
					PLAYER_TAIL.push(PLAYER.getTile());
				} else if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PATH) {
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
				}
			} else { // not claiming, can only move to another PATH tile
				if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PATH) {
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
				}
			}
		}
	}
}
window.setInterval(movePlayer, 1000 / 15);

function openURL(_url) {
	if (_url == "") {
		return;
	}
	if (!IS_PAUSED) {
		pauseGame(document.getElementById("btn_pause"));
		pausePlayLeave(document.getElementById("btn_pause"));
	}
	window.open(_url, "_blank").focus();
}

function loadLevel() {
	// reseting elements
	GRID = new Grid(0, 0, GRID_ROWS, GRID_COLS, CEL_HEIGHT);
	var playerLives = PLAYER.lives;
	PLAYER = new Player(GRID.map[GRID.rows - 1][GRID.columns / 2]);
	PLAYER.lives = playerLives;
	QIX = new Qix(GRID.map[GRID.rows / 2][GRID.columns / 2]);
	SPARX1 = new Sparx(GRID.map[0][Math.floor(Math.random() * (GRID.columns - 2))], (Math.floor(Math.random() * 10) > 5) ? true : false);
	SPARX2 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][0], (Math.floor(Math.random() * 10) > 5) ? true : false);
	SPARX3 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][GRID.columns - 1], (Math.floor(Math.random() * 10) > 5) ? true : false);
	sparxList = [SPARX1, SPARX2, SPARX3];
	PAUSED_IMG.style.visibility = "hidden";
	NEXT_LEVEL_IMG.style.visibility = "hidden";

	// updating UI
	updateLives(PLAYER.lives);
	updateLevel(LEVELS.level);
	updateClaimedPercent(0);
	updateGoal(LEVELS.getCurrentLevel().goal);
	document.getElementById("player_head_img").src = LEVELS.getAvatarImg();
	document.getElementById("player_head_img").title = LEVELS.avatar.getTitle();
	document.getElementById("cute_head_img").src = LEVELS.getCuteHead();
	document.getElementById("cute_head_img").title = LEVELS.cute.getTitle();
	document.getElementById("bCuteName").innerHTML = CUTES.getSelectedCute().name;

	var td = document.getElementById("td_game");
	td.replaceChildren();
	var bgImg = newImage(LEVELS.getCurrentLevel().cuteImg, 600, "relative", 0, 0, 1, "");
	bgImg.id = "BgImg";
	td.appendChild(bgImg);

	if (LEVELS.cute.info && LEVELS.cute.getInfo(LEVELS.level)) {
		document.getElementById("info_text").textContent = LEVELS.cute.getInfo(LEVELS.level);
	} else {
		document.getElementById("info_text").textContent = "Â ";
	}

	for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
		for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
			var tile = GRID.map[rowIdx][colIdx];
			var celImg = newImage(tile.tileType.img, tile.pixels, "absolute", tile.y, tile.x, COVER_ZINDEX, "");
			celImg.id = "img_" + rowIdx + "_" + colIdx;
			td.appendChild(celImg);
		}
	}

	td.appendChild(PLAYER.img);
	td.appendChild(QIX.img);
	td.appendChild(QIX.imgMid);
	td.appendChild(QIX.imgTail);
	for (i = 0; i < sparxList.length; i++) {
		td.appendChild(sparxList[i].img);
	}

	td.appendChild(PAUSED_IMG);
	td.appendChild(NEXT_LEVEL_IMG);
	IS_PAUSED = false;
	IS_GAME_OVER = false;
}

function loadCutesFromLocalStorage() {
	for (var i = 0; i < CUTES.cutes.length; i++) {
		for (var j = 0; j < CUTES.cutes[i].levelImgs.length; j++) {
			var key = getCuteLocalStorageKey(CUTES.cutes[i].id, j);
			var revealed = localStorage.getItem(key + "_rev");
			if (revealed == "Y") {
				CUTES.cutes[i].levelImgs[j].revealed = true;
				IMAGES_REVEALED++;
			}

			var maxPercentage = localStorage.getItem(key + "_max");
			if (maxPercentage != "" && !isNaN(maxPercentage)) {
				CUTES.cutes[i].levelImgs[j].setMaxPercentage(maxPercentage);
			}
		}
	}
	IMAGES_REVEALED = 99;
}

function onLoad() {
	loadCutesFromLocalStorage();
	displayAvatars();
	displayCutes();
	document.getElementById("AvatarModal").style.display = "block";
}

function pausePlayHover(img) {
	if (IS_PAUSED) {
		img.src = "./img/play_hover.png";
	} else {
		img.src = "./img/pause_hover.png";
	}
}

function pausePlayLeave(img) {
	if (IS_PAUSED) {
		img.src = "./img/play.png";
	} else {
		img.src = "./img/pause.png";
	}
}

function pauseGame(img) {
	IS_PAUSED = !IS_PAUSED;
	PAUSED_IMG.style.visibility = (IS_PAUSED ? "visible" : "hidden");
	pausePlayHover(img);
}

function startGame() {
	if (!confirm("Do you want to start a new game?")) {
		return;
	}
	IS_PAUSED = true;

	displayAvatars();
	displayCutes();

	document.getElementById("btn_pause").src = "./img/pause.png";
	PLAYER = new Player(GRID.map[GRID.rows - 1][GRID.columns / 2]);
	document.getElementById("AvatarModal").style.display = "block";
}

function moveKeysLeave() {
	document.getElementById("movement_keys_img").src = "./img/movement_keys_0.png";
	document.getElementById("tr_pre_movement_text").style = "display:none";
	document.getElementById("tr_movement_text").style = "display:none";
}

function moveKeysOver() {
	document.getElementById("movement_keys_img").src = "./img/movement_keys_1.png";
	document.getElementById("tr_pre_movement_text").style = "display:";
	document.getElementById("tr_movement_text").style = "display:";
}

function showCredits() {
	if (!IS_PAUSED) {
		pauseGame(document.getElementById("btn_pause"));
		pausePlayLeave(document.getElementById("btn_pause"));
	}
	creditsModal.style.display = "block";
}

function resetProgress() {
	if (confirm("Do you want to reset all your progress? This operation is not reversible.")) {
		for (var i = 0; i < CUTES.cutes.length; i++) {
			for (var j = 0; j < CUTES.cutes[i].levelImgs.length; j++) {
				var key = getCuteLocalStorageKey(CUTES.cutes[i].id, j);
				localStorage.removeItem(key + "_max");
				localStorage.removeItem(key + "_rev");
				CUTES.cutes[i].levelImgs[j].revealed = false;
				CUTES.cutes[i].levelImgs[j].setMaxPercentage(0);
			}
		}
		IMAGES_REVEALED = 0;
	}
}

window.addEventListener("keydown", function (e) {
	//console.log("e.keyCode: " + e.keyCode)
    KEYS[e.keyCode] = true;
});

window.addEventListener("keyup", function (e) {
    KEYS[e.keyCode] = false;
});
</script>

<body bgcolor="BLACK" onload="onLoad()" id="html_body_id">
<table id="main_table">
<tbody>
<tr style="position: relative;">
	<td id="td_game" class="tops" style="position: relative;">
		<!--img width="900" height="600" id="BgImg" src="./img/empty_tile.png" title="Revealed"/-->
	</td>
	<td rowspan="4"><img align="center" width="5px" src="./img/empty_tile.png"/></td>
	<td rowspan="4" class="tops">
		<table>
			<tr>
				<td><img class="round" align="center" width="202" id="CuteQix-Logo" src="./CuteQix-Logo.png" title="CuteQix (v0.1)"/></td>
			</tr>
			<tr>
				<td><img height="5px" src="./img/empty_tile.png"/></td>
			</tr>
			<tr>
				<td><img align="center" width="202" src="./img/player_and_cute.png"/></td>
			</tr>
			<tr>
				<td align="center">
					<img height="140" class="round" id="player_head_img" src="./img/empty_tile.png" title="Player"/>
					<img width="9px" src="./img/empty_tile.png"/>
					<img height="140" class="round" id="cute_head_img" src="./img/empty_tile.png" title="Cute"/>
				</td>
			</tr>
			<tr>
				<td bgcolor="white" align="center" class="round">
					<table>
						<tr>
							<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
						<tr>
							<td align="left" style="font-family:'Calibri'; font-size:15px;"><b id="bCuteName"></b></td>
						</tr>
						<tr>
							<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
			</tr>
			<tr>
				<td bgcolor="white" align="center" class="round">
					<table style="font-family:'Calibri'; font-size:15px;">
						<tr>
							<td>Lives: <b><span id="lives_text">10</span></b></td>
							<td><img width="10px" src="./img/empty_tile.png"/></td>
							<td>Level: <b><span id="level_text">1</span></b></td>
						</tr>
						<tr>
							<td>Claimed: <b><span id="claimed_text">0</span>%</b></td>
							<td><img width="10px" src="./img/empty_tile.png"/></td>
							<td>Goal: <b><span id="goal_text">60</span>%</b></td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
			</tr>
			<tr>
				<td align="center">
					<img height="24px" id="btn_pause" class="clickable" src="./img/pause.png" title="Pause" onmouseover="pausePlayHover(this)" onmouseleave="pausePlayLeave(this)" onclick="pauseGame(this)"/>
					<img width="10px" src="./img/empty_tile.png"/>
					<img height="24px" id="btn_restart" class="clickable" src="./img/restart.png" title="Restart" onmouseover="this.src='./img/restart_hover.png'" onmouseleave="this.src='./img/restart.png'" onclick="startGame()"/>
				</td>
			</tr>
			<tr>
				<td><img align="left" height="1px" src="./img/empty_tile.png"/></td>
			</tr>
			<tr>
				<td bgcolor="white" align="center" onmouseover="moveKeysOver()" onmouseleave="moveKeysLeave()" title="Movement Keys" class="round">
					<table>
						<tr>
							<td><img align="center" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
						<tr>
							<td>
								<img id="movement_keys_img" height="56" align="center" src="./img/movement_keys_0.png" title="Movement Keys"/>
								<img align="left" height="5px" src="./img/empty_tile.png"/>
								<img id="space_key_img" height="27" align="center" src="./img/space_key.png" title="Space Key"/><br/>
							</td>
						</tr>
						<tr>
							<td><img align="center" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
					</table>
					
				</td>
			</tr>
			<tr>
				<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
			</tr>
			<tr>
				<td bgcolor="white" align="center" title="Movement Keys" class="round">
					<table style="font-family:'Calibri'; font-size:15px;">
						<tr>
							<td align="center">Use W, A, S, D, or the arrow<br/> keys to move the cursor.</td>
						</tr>
						<tr>
							<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
						<tr>
							<td align="center">Keep the Space key pressed<br/> to capture.</td>
						</tr>
						<tr>
							<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
						<tr>
							<td align="center">Don't let the enemies hit you.</td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
			</tr>
			<tr>
				<td bgcolor="white" align="center" class="round">
					<table style="font-family:'Calibri'; font-size:15px;">
						<tr>
							<td align="center"><img id="staticPlayer" height="10px" width="10px" src="./img/player_00.png"/></td>
							<td><img height="5px" src="./img/empty_tile.png"/></td>
							<td>Player</td>
						</tr>
						<tr>
							<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
						<tr>
							<td align="center"><img id="staticQix" height="10px" width="30" src="./img/qix_00.png"/></td>
							<td><img height="5px" src="./img/empty_tile.png"/></td>
							<td>Qix (enemy)</td>
						</tr>
						<tr>
							<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
						<tr>
							<td align="center"><img id="staticSparx" height="10px" width="10" src="./img/sparx_00.png"/></td>
							<td><img height="5px" src="./img/empty_tile.png"/></td>
							<td>Sparx (enemy)</td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
			</tr>
			<tr>
				<td bgcolor="white" align="center" class="round clickable" onclick="showCredits()">
					<table>
						<tr>
							<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
						<tr>
							<td style="font-family:'Calibri'; font-size:15px;"><b>Credits</b></td>
						</tr>
						<tr>
							<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
	</td>
</tr>
<tr>
	<td>
		<div id="myProgress">
			<b style="font-family:'Calibri'; font-size:12px;"><div id="myTarget">0%</div></b>
			<b style="font-family:'Calibri'; font-size:12px;"><div id="myBar">0%</div></b>
		</div>
	</td>
</tr>
<tr>
	<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
</tr>
<tr>
	<td class="round" align="center" bgcolor="white" style="font-family:'Calibri'; font-size: 15"><span id="info_text"></span></td>
</tr>
</tbody>
</table>

<!-- The AvatarModal -->
<div id="AvatarModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
	<div class="sticky">
		<p align="center" class="round bg"><img class="round" width="500" id="CuteQix-Logo" src="./CuteQix-Logo2.png" title="CuteQix"/></p>
		<p align="center" class="round">Select your Avatar:</p>
	</div>
	<table id="t_AvatarList" align="center">
		<tr>
			<td></td>
		</tr>
		<tr><td><img height='30px' src='./img/empty_tile.png'/></td></tr>
	</table>
  </div>
</div>

<!-- The CuteModal -->
<div id="CuteModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
	<div class="sticky">
		<p align="center" class="round bg"><img class="round" width="500" id="CuteQix-Logo" src="./CuteQix-Logo2.png" title="CuteQix"/></p>
		<p align="center" class="round">Select a Level:</p>
	</div>
	<table id="t_CuteList" align="center">
		<tr>
			<td></td>
		</tr>
		<tr><td><img height='30px' src='./img/empty_tile.png'/></td></tr>
	</table>
	<br>
  </div>
</div>

<!-- The ImgModal -->
<div id="ImgModal" class="modal2">
  <!-- Modal content -->
  <div class="modal-content">
	<table align="center">
		<tr>
			<td><img class="leftArrow clickable" onmouseover="this.src='./img/left_hover.png'" onmouseleave="this.src='./img/left.png'" id="imgLeft" src="./img/left.png"/></td>
			<td><img class="round" id="levelImgModal" align="center" height="600" src="./img/cute_001-01.webp"/></td>
			<td><img class="rightArrow clickable" onmouseover="this.src='./img/right_hover.png'" onmouseleave="this.src='./img/right.png'" id="imgRight" src="./img/right.png"/></td>
			<td><p id="pInfoText" style="font-family:'Calibri'; font-size:15" class="round white info"></p></td>
			<td class="tops"><span class="close" title="Close">&times;</span></td>
		</tr>
	</table>
  </div>
</div>

<!-- The CreditsModal -->
<div id="CreditsModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
	<div class="sticky">
		<p align="center" class="round bg"><img class="round" width="500" id="CuteQix-Logo" src="./CuteQix-Logo2.png" title="CuteQix"/></p>
		<p align="center" class="round">Credits: (v0.2)</p>
		<span class="closeCredits" title="Close">&times;</span>
	</div>
	<br>
	<table id="t_Credits" align="center" style="font-family:'Calibri'">
		<tr>
			<td class="tops">
				<img class="round" width="320px" src="./CuteQix_Logo3.webp" title="CuteQix"/><br/>
				<img class="round" width="320px" src="./CuteQix_Logo2.webp" title="CuteQix"/><br/>
				<img class="round" width="320px" src="./CuteQix_Logo.webp" title="CuteQix"/><br/>
			</td>
			<td><img width="30px" src="./img/empty_tile.png"/></td>
			<td class="tops">
				<table>
					<tr>
						<td><p align="center" class="round">CuteQix developed by:</p></td>
					</tr>
					<tr>
						<td align="center"><p class="gray round"><b>Imperfect Lines Games</b></p></td>
					</tr>
					<tr>
						<td align="center"><img class="round" src="./ImperfectLinesGames-Logo.png"/></td>
					</tr>
					<tr>
						<td><p align="center" class="round">Inspired by the game Qix</p></td>
					</tr>
					<tr>
						<td align="right">Jan-2024</td>
					</tr>
					<tr>
						<td><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/></td>
					</tr>
					<tr>
						<td align="right" style="font-size:11"><span onclick="resetProgress()" style="font-family:'Calibri'" class="clickable"><u>Reset all your progress</u></span></td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
	<br>
  </div>
</div>

<script>
// Get the avatarModal
var avatarModal = document.getElementById("AvatarModal");

// Get the cuteModal
var cuteModal = document.getElementById("CuteModal");

// Get the ImgModal
var imgModal = document.getElementById("ImgModal");

// Get the CreditsModal
var creditsModal = document.getElementById("CreditsModal");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];
var spanCredits = document.getElementsByClassName("closeCredits")[0];

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  imgModal.style.display = "none";
}

spanCredits.onclick = function() {
  creditsModal.style.display = "none";
}

function avatarImage(_i) {
	var img = new Image();
	if (IMAGES_REVEALED >= AVATARS.avatars[_i].toUnlock) {
		img.src = AVATARS.avatars[_i].img;
		img.title = AVATARS.avatars[_i].getTitle();
		img.classList.add("clickable");
		img.classList.add("round");
		img.onclick = function() { setAvatar(_i); }
	} else {
		img.src = "./img/question_mark.png";
		img.title = "Play more levels to unlock this Avatar";
		img.classList.remove("clickable");
		img.onclick = null;
	}
	img.height = 140;
	return img;
}

function cuteImage(_i) {
	var img = new Image();
	if (IMAGES_REVEALED >= CUTES.cutes[_i].toUnlock) {
		img.src = CUTES.cutes[_i].img;
		img.title = CUTES.cutes[_i].getTitle();
		img.classList.add("clickable");
		img.classList.add("round");
		img.onclick = function() { setCute(_i); }
	} else {
		img.src = "./img/question_mark.png";
		img.title = "Play more levels to unlock this Level";
		img.classList.remove("clickable");
		img.onclick = null;
	}
	img.height = 140;
	return img;
}

function newEmptyImg() {
	var img = new Image();
	img.src = "./img/empty_tile.png";
	img.height = "20";
	img.width = "20";
	return img;
}

function displayAvatars() {
	var tAvatarList = document.getElementById("t_AvatarList");
	tAvatarList.replaceChildren();

	var rowCount = 0;
	var row1 = null;
	var row2 = null;
	var cell1 = null;
	var cell2 = null;
	var cell3 = null;
	var cell4 = null;

	for (var i = 0; i < AVATARS.avatars.length; i++) {
		if (((i + 1) % 4) == 1) {
			row1 = tAvatarList.insertRow(rowCount++);
		}
		cell1 = row1.insertCell();
		cell1.appendChild(avatarImage(i));

		cell2 = row1.insertCell();
		cell2.classList.add("round");
		cell2.style.backgroundColor = "white";
		cell2.style.padding = "5px";
		cell2.align = "center";
		if (IMAGES_REVEALED >= AVATARS.avatars[i].toUnlock) {
			cell2.innerHTML = "<p class='round'>" + AVATARS.avatars[i].name + "<br/>(" + AVATARS.avatars[i].fromGame + ")</p>";
		} else {
			var _s = "";
			if ((AVATARS.avatars[i].toUnlock - IMAGES_REVEALED) > 1) {
				_s = "s";
			}
			cell2.innerHTML = "<p class='round small'>Reveal " + (AVATARS.avatars[i].toUnlock - IMAGES_REVEALED) + " more image" + _s + " to unlock this avatar</p>";
		}

		if (((i + 1) % 4) == 0) {
			row2 = tAvatarList.insertRow(rowCount++);
			cell4 = row2.insertCell();
			cell4.appendChild(newEmptyImg());
		} else {
			cell3 = row1.insertCell();
			cell3.appendChild(newEmptyImg());
		}
	}
}

function navigationImageLeftRight(_cute, _level) {
	var imgLeft = document.getElementById("imgLeft");
	imgLeft.style.pointerEvents = "auto";
	var imgRight = document.getElementById("imgRight");
	imgRight.style.pointerEvents = "auto";

	if (_level == 1) {
		imgLeft.style.pointerEvents = "none";
		
		if (CUTES.cutes[_cute].getLevelImg(_level + 1).isRevealed()) {
			imgRight.onclick = function() { setFullImage(_cute, (_level + 1)); }
		} else {
			imgRight.style.pointerEvents = "none";
		}
	} else if (_level == 2) {
		imgLeft.onclick = function() { setFullImage(_cute, (_level - 1)); }
		imgRight.onclick = function() { setFullImage(_cute, (_level + 1)); }
	} else if (_level == 3) {
		imgLeft.onclick = function() { setFullImage(_cute, (_level - 1)); }
		imgRight.style.pointerEvents = "none";
	}
}

function setInfoText(_cute, _level) {
	var p = document.getElementById("pInfoText");

	if (CUTES.cutes[_cute].info && CUTES.cutes[_cute].getInfo(_level)) {
		document.getElementById("pInfoText").textContent = "Â " + CUTES.cutes[_cute].getInfo(_level) + "Â ";
	} else {
		document.getElementById("pInfoText").textContent = "";
	}

}

function setFullImage(_cute, _level) {
	var img = document.getElementById("levelImgModal");
	img.src = "./img/cute_" + CUTES.cutes[_cute].id + "-0" + _level + ".webp";
	navigationImageLeftRight(_cute, _level);
	setInfoText(_cute, _level);
}

function showUncoveredImg(_cute, _level) {
	setFullImage(_cute, _level);
	imgModal.style.display = "block";
}

function getCheckImg(_cute, _level) {
	var img = new Image();
	img.title = "Level " + _level + " image max percentage: " + CUTES.cutes[_cute].getLevelImg(_level).maxPercentage + "%";
	if (CUTES.cutes[_cute].getLevelImg(_level).isRevealed()) {
		img.src = "./img/check_true.png";
		img.classList.add("clickable");
		if (CUTES.cutes[_cute].getInfo(_level)) {
			img.title += "\r\n" + CUTES.cutes[_cute].getInfo(_level);
		}
		img.onclick = function() { showUncoveredImg(_cute, _level); }
	} else {
		img.src = "./img/check_false.png";
		img.classList.remove("clickable");
	}
	return img;
}

function getCuteNameTable(_i) {
	var t = document.createElement('table');

	var r0 = t.insertRow(0);
	var cellName = r0.insertCell();
	cellName.align = "center";

	if (IMAGES_REVEALED >= CUTES.cutes[_i].toUnlock) {
		cellName.colSpan = 3;
		cellName.innerHTML = "<p class='round'>" + CUTES.cutes[_i].name + "<br/>(" + CUTES.cutes[_i].fromGame + ")</p>";

		var r1 = t.insertRow(1);
		for (var i = 1; i <= 3; i++) {
			var cell = r1.insertCell();
			cell.align = "center";
			cell.style.padding = "5px";
			cell.appendChild(getCheckImg(_i, i));
		}
	} else {
		var _s = "";
		if ((CUTES.cutes[_i].toUnlock - IMAGES_REVEALED) > 1) {
			_s = "s";
		}
		cellName.innerHTML = "<p class='round small'>Reveal " + (CUTES.cutes[_i].toUnlock - IMAGES_REVEALED) + " more image" + _s + " to unlock this level</p>";
	}


	return t;
}

function displayCutes() {
	var tCuteList = document.getElementById("t_CuteList");
	tCuteList.replaceChildren();

	var rowCount = 0;
	var row1 = null;
	var row2 = null;
	var cell1 = null;
	var cell2 = null;
	var cell3 = null;
	var cell4 = null;

	for (var i = 0; i < CUTES.cutes.length; i++) {
		if (((i + 1) % 4) == 1) {
			row1 = tCuteList.insertRow(rowCount++);
		}
		cell1 = row1.insertCell();
		cell1.appendChild(cuteImage(i));

		cell2 = row1.insertCell();
		cell2.classList.add("round");
		cell2.style.backgroundColor = "white";
		cell2.style.padding = "5px";
		cell2.align = "center";
		cell2.appendChild(getCuteNameTable(i));

		if (((i + 1) % 4) == 0) {
			row2 = tCuteList.insertRow(rowCount++);
			cell4 = row2.insertCell();
			cell4.appendChild(newEmptyImg());
		} else {
			cell3 = row1.insertCell();
			cell3.appendChild(newEmptyImg());
		}
	}
}

function setAvatar(_seq) {
	AVATARS.selectedAvatar = _seq;
	displayCutes();
	avatarModal.style.display = "none";
	cuteModal.style.display = "block";
}

function setCute(_seq) {
	CUTES.selectedCute = _seq;
	cuteModal.style.display = "none";
	LEVELS = new Levels(AVATARS.getSelectedAvatar(), CUTES.getSelectedCute());
	loadLevel();
}
</script>

</body>
</html>
