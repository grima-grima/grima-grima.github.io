<html>
<head>
	<title>LewdQix</title>
	<link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
	<link rel="stylesheet" href="./main.css">
</head>

<script>
const CEL_HEIGHT = 10;
const GRID_ROWS = 60;
const GRID_COLS = 90;
const COVER_ZINDEX = 1000;
const PATH_ZINDEX = 1100;
const PLAYER_ZINDEX = 1200;
const SPARX_ZINDEX = 1300;
const QIX_ZINDEX = 1400;
const PAUSE_ZINDEX = 2000;
const ANIMATION_INTERVAL = 100;

var KEYS = [];
var IS_PAUSED = false;

function TileType(_type, _img) {
	this.type = _type;
	this.img = _img;
}

const _EMPTY = "EMPTY";
const EMPTY = new TileType(_EMPTY, "./img/dark_tile.png");

const _PATH = "PATH";
const PATH = new TileType(_PATH, "./img/white_tile.png");

const _PUSH = "PUSH";
const PUSH = new TileType(_PUSH, "./img/gray_tile.png");

const _CLAIM = "CLAIM";
const CLAIM = new TileType(_CLAIM, "./img/empty_tile.png");

const _DEADPATH = "DEADPATH";
const DEADPATH = new TileType(_DEADPATH, "./img/semi_tile.png");

function Tile(_x, _y, _pixels, _row, _col, _tileType) {
	this.x = _x;
	this.y = _y;
	this.pixels = _pixels;
	this.row = _row;
	this.col = _col;
	this.tileType = _tileType;
	this.hasQix = false;
	this.hasSparx = false;
	this.hasPlayer = false;
	this.hasPush = false;
}

function Grid(_x, _y, _rows, _columns, _tileSize) {
	this.rows = _rows;
	this.columns = _columns;
	this.map = [];
	this.inGrid = function(_row, _col) { return _row >= 0 && _row < this.rows && _col >= 0 && _col < this.columns; }

	for (row = 0; row < this.rows; row++) {
		this.map[row] = [];
		for (col = 0; col < this.columns; col++) {
			_tileType = EMPTY;
			//_tileType = CLAIM;
			//_tileType = DEADPATH;

			// the border of the initial grid must be set as PATH
			// first row, first column, last row and last column
			if (row == 0 || col == 0 || row == (this.rows - 1) || col == (this.columns - 1)) {
				_tileType = PATH;
			}

			this.map[row][col] = new Tile(col * _tileSize + _x, row * _tileSize + _y, _tileSize, row, col, _tileType);
		}
	}
}

var GRID = new Grid(0, 0, GRID_ROWS, GRID_COLS, CEL_HEIGHT);

function newImage(src, height, position, top, left, zIndex, alt) {
	var img = new Image();
	img.src = src;
	img.height = height;
	img.style.position = position;
	img.style.top = top;
	img.style.left = left;
	img.style.zIndex = zIndex;
	img.alt = alt;
	//img.onload = function() { positionImg(this); }
	return img;
}

var PAUSED_IMG = newImage("./img/paused.png", 120, "absolute", (((GRID_ROWS * CEL_HEIGHT) / 2) - (120 / 2) - 10), (((GRID_COLS * CEL_HEIGHT) / 2) - (250 / 2)), PAUSE_ZINDEX, "Game Paused");
PAUSED_IMG.id = "PausedImgModal";
PAUSED_IMG.style.visibility = "hidden";

function Player(_tile) {
	this.tile = _tile;
	GRID.map[_tile.row][_tile.col].hasPlayer = true;
	this.images = ["./img/player_00.png", "./img/player_01.png"];
	this.imgIdx = 0;
	this.img = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, PLAYER_ZINDEX, "Player");
	this.img.id = "player_img";
	this.isClaiming = false;

	this.getTile = function() { return this.tile; }
	this.setTile = function(_curr) {
		if (GRID.inGrid(_curr.row, _curr.col)) {
			GRID.map[this.tile.row][this.tile.col].hasPlayer = false;
			this.tile = _curr
			GRID.map[_curr.row][_curr.col].hasPlayer = true;
			this.img.style.top = _curr.y;
			this.img.style.left = _curr.x; 
		}
	}
	this.nextImg = function() {
		this.imgIdx++;
		if (this.imgIdx >= this.images.length) {
			this.imgIdx = 0;
		}
		this.img.src = this.images[this.imgIdx];
	}
}

var PLAYER = new Player(GRID.map[GRID.rows - 1][GRID.columns / 2]);
function playerNextImg() {
	PLAYER.nextImg();
}
window.setInterval(playerNextImg, ANIMATION_INTERVAL);


function Qix(_tile) {
	this.tile = _tile;
	this.mid = _tile;
	this.tail = _tile;
	GRID.map[_tile.row][_tile.col].hasQix = true;
	this.images = ["./img/qix_00.png", "./img/qix_01.png", "./img/qix_02.png"];
	this.imgIdx = 0;
	this.img = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, QIX_ZINDEX, "Qix");
	this.img.id = "qix_img";
	this.imgMid = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, QIX_ZINDEX, "Qix");
	this.imgMid.id = "qix_img_mid";
	this.imgTail = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, QIX_ZINDEX, "Qix");
	this.imgTail.id = "qix_img_tail";
	this.velX = 0;
	this.velY = 0;
	this.tickCounter = 0;

	this.getTile = function() { return this.tile; }
	this.setTile = function(_curr) {
		if (GRID.inGrid(_curr.row, _curr.col)) {
			GRID.map[this.tile.row][this.tile.col].hasQix = false;
			this.tail = this.mid;
			this.mid = this.tile;
			this.tile = _curr
			GRID.map[_curr.row][_curr.col].hasQix = true;
			this.img.style.top = _curr.y;
			this.img.style.left = _curr.x;
			this.imgMid.style.top = this.mid.y;
			this.imgMid.style.left = this.mid.x;
			this.imgTail.style.top = this.tail.y;
			this.imgTail.style.left = this.tail.x;
		}
	}
	this.nextImg = function() {
		this.imgIdx++;
		if (this.imgIdx >= this.images.length) {
			this.imgIdx = 0;
		}
		this.img.src = this.images[this.imgIdx];
		this.imgMid.src = this.images[this.imgIdx];
		this.imgTail.src = this.images[this.imgIdx];
	}
	this.move = function() {
		if (IS_PAUSED) {
			return;
		}
		this.tickCounter++;
		if (this.tickCounter >= 10) {
			this.tickCounter = 0;
			switch (Math.floor(Math.random() * 7)) {
				case 0: this.velX = 1; this.velY = 0; break;
				case 1: this.velX = -1; this.velY = 0; break;
				case 2: this.velX = 0; this.velY = 1; break;
				case 3: this.velX = 0; this.velY = -1; break;
				case 4: this.velX = 1; this.velY = 1; break;
				case 5: this.velX = -1; this.velY = -1; break;
				case 6: this.velX = 1; this.velY = -1; break;
				default: this.velX = -1; this.velY = 1;
			}
		}
		var newRow = this.tile.row + this.velY;
		var newCol = this.tile.col + this.velX;
		if (GRID.inGrid(newRow, newCol)) {
			var newTile = GRID.map[newRow][newCol];
			if (newTile.tileType != PATH) {
				this.setTile(newTile);
			} else {
				this.velY *= -1;
				this.velX *= -1;
				newRow = this.tile.row + this.velY;
				newCol = this.tile.col + this.velX;
				newTile = GRID.map[newRow][newCol];
				if (newTile.tileType != PATH) {
					this.setTile(newTile);
				}
			}
		}
	}
}

var QIX = new Qix(GRID.map[GRID.rows / 2][GRID.columns / 2]);
function qixMove() {
	QIX.nextImg();
	QIX.move();
}
window.setInterval(qixMove, ANIMATION_INTERVAL);


function Sparx(_tile, _clockwise) {
	this.tile = _tile;
	this.prev = _tile;
	this.clockwise = _clockwise;
	GRID.map[_tile.row][_tile.col].hasSparx = true;
	this.images = ["./img/sparx_00.png", "./img/sparx_01.png"];
	this.imgIdx = 0;
	this.img = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, SPARX_ZINDEX, "Sparx");
	this.img.id = "sparx_img";
	this.canMove = false;

	this.getTile = function() { return this.tile; }
	this.setTile = function(_curr) {
		if (GRID.inGrid(_curr.row, _curr.col)) {
			GRID.map[this.tile.row][this.tile.col].hasSparx = false;
			this.prev = this.tile
			this.tile = _curr
			GRID.map[_curr.row][_curr.col].hasSparx = true;
			this.img.style.top = _curr.y;
			this.img.style.left = _curr.x; 
		}
	}
	this.nextImg = function() {
		this.imgIdx++;
		if (this.imgIdx >= this.images.length) {
			this.imgIdx = 0;
		}
		this.img.src = this.images[this.imgIdx];
	}
	this.move = function() {
		if (IS_PAUSED) {
			return;
		}
		if (this.canMove) {
			// if first move
			if (this.prev.row == this.tile.row && this.prev.col == this.tile.col) {
				if (this.clockwise) {
					if (this.tile.row == 0) {
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (this.tile.col == 0) {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					}
				} else {
					if (this.tile.row == 0) {
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (this.tile.col == 0) {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					}
				}
			} else {
				// not first move
				if ((this.tile.col - this.prev.col) > 0) { // left to right
					if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == PATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == PATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == DEADPATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == DEADPATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					}
				} else if ((this.tile.row - this.prev.row) > 0) { // up to down
					if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == PATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == PATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == DEADPATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == DEADPATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					}
				} else if ((this.tile.col - this.prev.col) < 0) { // right to left
					if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == PATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == PATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == DEADPATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == DEADPATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					}
				} else { // down to up
					if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == PATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == PATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == DEADPATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == DEADPATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					}
				}
			}
		}
		this.canMove = !this.canMove;
	}
}

var SPARX1 = new Sparx(GRID.map[0][Math.floor(Math.random() * (GRID.columns - 2))], (Math.floor(Math.random() * 10) > 5) ? true : false);
var SPARX2 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][0], (Math.floor(Math.random() * 10) > 5) ? true : false);
var SPARX3 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][GRID.columns - 1], (Math.floor(Math.random() * 10) > 5) ? true : false);
//var sparxList = [SPARX1];
var sparxList = [SPARX1, SPARX2, SPARX3];
function sparxMove() {
	for (i = 0; i < sparxList.length; i++) {
		sparxList[i].nextImg();
		sparxList[i].move();
	}
}
window.setInterval(sparxMove, ANIMATION_INTERVAL * 1.0);


function pushIfEmpty(_row, _col) {
	if (GRID.map[_row][_col].tileType == EMPTY) {
		GRID.map[_row][_col].tileType = PUSH;
		var img = document.getElementById("img_" + _row + "_" + _col);
		img.src = PUSH.img;
	}
}

var VEL_L = 0;
var VEL_R = 0;
var VEL_U = 0;
var VEL_D = 0;

function unclaim(_tile) {
	var tiles = [];
	tiles.push(_tile);
	
	while (tiles.length > 0) {
		var t = tiles.pop();
		if (t.tileType == CLAIM) {
			t.tileType = EMPTY;
			if (GRID.inGrid(t.row + 1, t.col)) {
				tiles.push(GRID.map[t.row + 1][t.col]);
			}
			if (GRID.inGrid(t.row - 1, t.col)) {
				tiles.push(GRID.map[t.row - 1][t.col]);
			}
			if (GRID.inGrid(t.row, t.col + 1)) {
				tiles.push(GRID.map[t.row][t.col + 1]);
			}
			if (GRID.inGrid(t.row, t.col - 1)) {
				tiles.push(GRID.map[t.row][t.col - 1]);
			}

			if (GRID.inGrid(t.row + 1, t.col + 1)) {
				tiles.push(GRID.map[t.row + 1][t.col + 1]);
			}
			if (GRID.inGrid(t.row - 1, t.col + 1)) {
				tiles.push(GRID.map[t.row - 1][t.col + 1]);
			}
			if (GRID.inGrid(t.row + 1, t.col - 1)) {
				tiles.push(GRID.map[t.row + 1][t.col - 1]);
			}
			if (GRID.inGrid(t.row - 1, t.col - 1)) {
				tiles.push(GRID.map[t.row - 1][t.col - 1]);
			}
		} else if (t.tileType == DEADPATH) {
			t.tileType = PATH;
		}
	}
}

function updateGrid() {
	for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
		for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
			var img = document.getElementById("img_" + rowIdx + "_" + colIdx);
			img.src = GRID.map[rowIdx][colIdx].tileType.img;
		}
	}
}


function countEmpty() {
	var count = 0;
	for (var i = 0; i < GRID_ROWS; i++) {
		for (var j = 0; j < GRID_COLS; j++) {
			if (GRID.map[i][j].tileType == EMPTY || GRID.map[i][j].tileType == PATH) {
				count++;
			}
		}
	}
	return count;
}

function getClaimPercent() {
	return Math.round((GRID_ROWS * GRID_COLS - countEmpty()) / (GRID_ROWS * GRID_COLS) * 100);
}

var wasPushing = false;
function claim() {
	for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
		for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
			if (GRID.map[rowIdx][colIdx].tileType == PATH || GRID.map[rowIdx][colIdx].tileType == PUSH) {
				GRID.map[rowIdx][colIdx].tileType = DEADPATH;
			} else if (GRID.map[rowIdx][colIdx].tileType == EMPTY) {
				GRID.map[rowIdx][colIdx].tileType = CLAIM;
			}
		}
	}
	unclaim(QIX.tile);
	updateGrid();
	document.getElementById("claimed_text").textContent = getClaimPercent();
}

function movePlayer() {
	if (IS_PAUSED) {
		return;
	}

	VEL_R = 0;
	if (KEYS[39] || KEYS[68]) { // 39 = right / 68 = "D"
		VEL_R = 1;
	}

	VEL_L = 0;
	if (KEYS[37] || KEYS[65]) { // 37 = left / 65 = "A"
		VEL_L = -1;
	}

	VEL_U = 0;
	if (KEYS[38] || KEYS[87]) { // 38 = up / 87 = "W"
		VEL_U = -1;
	}

	VEL_D = 0;
	if (KEYS[40] || KEYS[83]) { // 40 = down / 83 = "S"
		VEL_D = 1;
	}

	PLAYER.isClaiming = false;
	if (KEYS[32]) { // space key
		PLAYER.isClaiming = true;
	}

	if (VEL_L != 0 || VEL_R != 0 || VEL_U != 0 || VEL_D != 0) {
		if (GRID.inGrid(PLAYER.getTile().row + VEL_U + VEL_D, PLAYER.getTile().col + VEL_L + VEL_R)) {
			//console.log("PLAYER.isClaiming: " + PLAYER.isClaiming)
			if (PLAYER.isClaiming) {
				if (wasPushing && GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PATH) {
					PLAYER.isClaiming = false;
					wasPushing = false;
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
					claim();
					return;
				}
				if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PUSH || GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == CLAIM) {
					return;
				}
				if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == EMPTY) {
					wasPushing = true;
				}
				if ((((VEL_L + VEL_R) > 0) && ((VEL_U + VEL_D) > 0)) || (((VEL_L + VEL_R) > 0) && ((VEL_U + VEL_D) < 0))) { // diagonal move -> (right and dowm) or (right and up)
					pushIfEmpty(PLAYER.getTile().row, PLAYER.getTile().col + VEL_L + VEL_R);
				} else if ((((VEL_L + VEL_R) < 0) && ((VEL_U + VEL_D) > 0)) || (((VEL_L + VEL_R) < 0) && ((VEL_U + VEL_D) < 0))) { // diagonal move -> (left and dowm) or (left and up)
					pushIfEmpty(PLAYER.getTile().row, PLAYER.getTile().col + VEL_L + VEL_R);
				}
				PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
				pushIfEmpty(PLAYER.getTile().row, PLAYER.getTile().col);
			} else { // not claiming, can only move to another PATH tile
				if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PATH) {
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
				}
			}
		}
	}
}
window.setInterval(movePlayer, 1000 / 20);


function onLoad() {
	var td = document.getElementById("td_game");
	var bgImg = newImage("./img/temp_bg_img.webp", 600, "relative", 0, 0, 1, "");
	bgImg.id = "BgImg";
	td.appendChild(bgImg);

	for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
		for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
			var tile = GRID.map[rowIdx][colIdx];
			var celImg = newImage(tile.tileType.img, tile.pixels, "absolute", tile.y, tile.x, COVER_ZINDEX, "");
			celImg.id = "img_" + rowIdx + "_" + colIdx;
			td.appendChild(celImg);
		}
	}

	td.appendChild(PLAYER.img);
	td.appendChild(QIX.img);
	td.appendChild(QIX.imgMid);
	td.appendChild(QIX.imgTail);
	for (i = 0; i < sparxList.length; i++) {
		td.appendChild(sparxList[i].img);
	}

	td.appendChild(PAUSED_IMG);
}

function pausePlayHover(img) {
	if (IS_PAUSED) {
		img.src = "./img/play_hover.png";
	} else {
		img.src = "./img/pause_hover.png";
	}
}

function pausePlayLeave(img) {
	if (IS_PAUSED) {
		img.src = "./img/play.png";
	} else {
		img.src = "./img/pause.png";
	}
}

function pauseGame(img) {
	IS_PAUSED = !IS_PAUSED;
	PAUSED_IMG.style.visibility = (IS_PAUSED ? "visible" : "hidden");
	pausePlayHover(img);
}

function startGame() {
	if (!confirm("Do you want to start a new game?")) {
		return;
	}
	IS_PAUSED = true;

	document.getElementById("btn_pause").src = "./img/pause.png";

	// reseting elements
	GRID = new Grid(0, 0, GRID_ROWS, GRID_COLS, CEL_HEIGHT);
	PLAYER = new Player(GRID.map[GRID.rows - 1][GRID.columns / 2]);
	QIX = new Qix(GRID.map[GRID.rows / 2][GRID.columns / 2]);
	SPARX1 = new Sparx(GRID.map[0][Math.floor(Math.random() * (GRID.columns - 2))], (Math.floor(Math.random() * 10) > 5) ? true : false);
	SPARX2 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][0], (Math.floor(Math.random() * 10) > 5) ? true : false);
	SPARX3 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][GRID.columns - 1], (Math.floor(Math.random() * 10) > 5) ? true : false);
	sparxList = [SPARX1, SPARX2, SPARX3];
	PAUSED_IMG.style.visibility = "hidden";

	var td = document.getElementById("td_game");
	td.replaceChildren();
	onLoad();
	IS_PAUSED = false;
}

function moveKeysLeave() {
	document.getElementById("movement_keys_img").src = "./img/movement_keys_0.png";
}
function moveKeysOver() {
	document.getElementById("movement_keys_img").src = "./img/movement_keys_1.png";
}

window.addEventListener("keydown", function (e) {
	//console.log("e.keyCode: " + e.keyCode)
    KEYS[e.keyCode] = true;
});

window.addEventListener("keyup", function (e) {
    KEYS[e.keyCode] = false;
});
</script>

<body bgcolor="BLACK" onload="onLoad()" id="html_body_id">
<table id="main_table">
<tbody>
<tr style="position: relative;">
	<td>&nbsp;</td>
	<td id="td_game" style="position: relative;">
		<!--img width="900" height="600" id="BgImg" src="./img/empty_tile.png" title="Revealed"/-->
	</td>
	<td>&nbsp;&nbsp;</td>
	<td class="tops">
		<table>
			<tr>
				<td colspan="3">
					<img valign="top" align="left" width="200" id="LewdQix-Logo" src="./LewdQix-Logo.png" title="Lewd Qix"/>
				</td>
			</tr>
			<tr>
				<td colspan="3">
					<img align="left" height="10px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td colspan="3" bgcolor="white" align="center" onmouseover="moveKeysOver()" onmouseleave="moveKeysLeave()" title="Movement Keys">
					<table>
						<tr>
							<td><b style="font-family:'Calibri'">Lives: <span id="lives_text">10</span></b></td>
						</tr>
						<tr>
							<td><b style="font-family:'Calibri'">Level: <span id="level_text">1</span></b></td>
						</tr>
						<tr>
							<td><b style="font-family:'Calibri'">Claimed: <span id="claimed_text">0</span>%</b></td>
						</tr>
						<tr>
							<td><b style="font-family:'Calibri'">Claim Goal: <span id="goal_text">60</span>%</b></td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td colspan="3">
					<img align="left" height="10px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td>
					<img align="left" height="48px" id="btn_pause" src="./img/pause.png" title="Pause" onmouseover="pausePlayHover(this)" onmouseleave="pausePlayLeave(this)" onclick="pauseGame(this)"/>
				</td>
				<td>
					<img align="left" height="2px" src="./img/empty_tile.png"/>
				</td>
				<td>
					<img align="left" height="48px" id="btn_restart" src="./img/restart.png" title="Restart" onmouseover="this.src='./img/restart_hover.png'" onmouseleave="this.src='./img/restart.png'" onclick="startGame()"/>
				</td>
			</tr>
			<tr>
				<td colspan="3">
					<img align="left" height="10px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td bgcolor="white" colspan="3">
					<img align="left" height="10px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td colspan="3" bgcolor="white" align="center" onmouseover="moveKeysOver()" onmouseleave="moveKeysLeave()" title="Movement Keys">
					<table>
						<tr>
							<td align="center">
								<img id="movement_keys_img" align="center" src="./img/movement_keys_0.png" title="Movement Keys"/>
							</td>
						</tr>
						<tr>
							<td>
								<img align="left" height="10px" src="./img/empty_tile.png"/>
							</td>
						</tr>
						<tr>
							<td align="center">
								<img id="space_key_img" align="center" src="./img/space_key.png" title="Space Key"/><br/>
							</td>
						</tr>
						<tr>
							<td align="center">
								<img align="left" height="10px" src="./img/empty_tile.png"/>
							</td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td colspan="3">
					<img align="left" height="10px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td colspan="3" bgcolor="white" align="center" onmouseover="moveKeysOver()" onmouseleave="moveKeysLeave()" title="Movement Keys">
					<table>
						<tr>
							<td align="center"><b style="font-family:'Calibri'">Use W, A, S, D,<br/> or the arrow keys<br/> to move the cursor</b></td>
						</tr>
						<tr>
							<td>
								<img align="left" height="10px" src="./img/empty_tile.png"/>
							</td>
						</tr>
						<tr>
							<td align="center"><b style="font-family:'Calibri'">Press the Space key<br/> to start capturing</b></td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
	</td>
</tr>
</tbody>
</table>

</body>
</html>