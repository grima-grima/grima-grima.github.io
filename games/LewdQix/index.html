<html>
<head>
	<title>LewdQix</title>
	<link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
	<link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
	<link rel="stylesheet" href="./main.css">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2328144309440460"
     crossorigin="anonymous"></script>
</head>

<script>
const CEL_HEIGHT = 10;
const GRID_ROWS = 60;
const GRID_COLS = 90;
const COVER_ZINDEX = 1000;
const PATH_ZINDEX = 1100;
const PLAYER_ZINDEX = 1200;
const SPARX_ZINDEX = 1300;
const QIX_ZINDEX = 1400;
const PAUSE_ZINDEX = 2000;
const ANIMATION_INTERVAL = 100;

var KEYS = [];
var IS_PAUSED = false;

var PLAYER_TAIL = [];

function TileType(_type, _img) {
	this.type = _type;
	this.img = _img;
}

const _EMPTY = "EMPTY";
const EMPTY = new TileType(_EMPTY, "./img/dark_tile.png");

const _PATH = "PATH";
const PATH = new TileType(_PATH, "./img/white_tile.png");

const _PUSH = "PUSH";
const PUSH = new TileType(_PUSH, "./img/gray_tile.png");

const _CLAIM = "CLAIM";
const CLAIM = new TileType(_CLAIM, "./img/empty_tile.png");

const _DEADPATH = "DEADPATH";
const DEADPATH = new TileType(_DEADPATH, "./img/semi_tile.png");

function LevelImg(_revealed, _maxPercentage) {
	this.revealed = _revealed;
	this.maxPercentage = _maxPercentage;
	this.isRevealed = function() { return this.revealed; }
	this.setMaxPercentage = function(_revealedPercent) {
		if (_revealedPercent > this.maxPercentage) {
			this.maxPercentage = _revealedPercent;
		}
	}
}

function Girl(_id, _name, _fromGame, _patreon) {
	this.id = _id;
	this.name = _name;
	this.fromGame = _fromGame;
	this.patreon = _patreon;
	this.img = "./img/girl_head_" + this.id + ".webp";
	this.levelImgs = [];
	this.levelImgs[0] = new LevelImg(false, 0);
	this.levelImgs[1] = new LevelImg(false, 0);
	this.levelImgs[2] = new LevelImg(false, 0);
	this.getTitle = function() { return this.name + "\r\n(From: " + this.fromGame + ")\r\n" + this.patreon; }
	this.getLevelImg = function(_level) { return this.levelImgs[_level - 1];}
}

function Girls() {
	this.selectedGirl = -1;
	this.girls = [];
	this.push = function(_girl) { this.girls.push(_girl); }
	this.getSelectedGirl = function() {
		if (this.selectedGirl == -1) {
			return null;
		} else {
			return this.girls[this.selectedGirl];
		}
	}
}
var GIRLS = new Girls();
GIRLS.push(new Girl("001", "Vanessa", "Girl In Charge", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("002", "Vanessa2", "Girl In Charge", ""));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("100", "Emily", "Our Home", "https://patreon.com/oldhiccup"));
GIRLS.push(new Girl("101", "Sabrina", "Our Home", "https://patreon.com/oldhiccup"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.push(new Girl("003", "???", "???", "https://www.patreon.com/grimagrima"));
GIRLS.selectedGirl = 0;

function Avatar(_id, _name, _fromGame) {
	this.id = _id;
	this.name = _name;
	this.fromGame = _fromGame;
	this.img = "./img/player_head_" + this.id + ".webp";
	this.getTitle = function() { return this.name + "\r\n(From: " + this.fromGame + ")"; }
}

function Avatars() {
	this.selectedAvatar = -1;
	this.avatars = [];
	this.push = function(_avatar) { this.avatars.push(_avatar); }
	this.getSelectedAvatar = function() {
		if (this.selectedAvatar == -1) {
			return null;
		} else {
			return this.avatars[this.selectedAvatar];
		}
	}
}
var AVATARS = new Avatars();
AVATARS.push(new Avatar("001", "Dylan", "Girl In Charge"));
AVATARS.push(new Avatar("002", "Dylan2", "Girl In Charge"));
AVATARS.push(new Avatar("003", "Silhouette", ""));
AVATARS.push(new Avatar("003", "Silhouette2", ""));
AVATARS.push(new Avatar("003", "Silhouette2", ""));
AVATARS.push(new Avatar("003", "Silhouette2", ""));
AVATARS.push(new Avatar("003", "Silhouette2", ""));
AVATARS.push(new Avatar("003", "Silhouette2", ""));
AVATARS.push(new Avatar("003", "Silhouette2", ""));
AVATARS.push(new Avatar("003", "Silhouette2", ""));
AVATARS.push(new Avatar("003", "Silhouette2", ""));
AVATARS.selectedAvatar = 0;


function Level(_girlImg, _goal) {
	this.girlImg = _girlImg;
	this.goal = _goal;
}

function Levels(_avatar, _girl) {
	this.avatar = _avatar;
	this.girl = _girl;
	this.level = 1;
	this.finished = false;
	this.levels = [
		new Level("./img/girl_" + this.girl.id + "-01.webp", 60),
		new Level("./img/girl_" + this.girl.id + "-02.webp", 70),
		new Level("./img/girl_" + this.girl.id + "-03.webp", 80)
	];
	this.getCurrentLevel = function() { return this.levels[this.level - 1]; }
	this.nextLevel = function() {
		if (this.level >= this.levels.length) {
			this.finished = true;
		} else {
			this.level++; 
		}
	}
	this.getAvatarImg = function() { return this.avatar.img; }
	this.getGirlHead = function() { return this.girl.img; }
}

function Tile(_x, _y, _pixels, _row, _col, _tileType) {
	this.x = _x;
	this.y = _y;
	this.pixels = _pixels;
	this.row = _row;
	this.col = _col;
	this.tileType = _tileType;
	this.hasQix = false;
	this.hasSparx = false;
	this.hasPlayer = false;
	this.hasPush = false;
}

function Grid(_x, _y, _rows, _columns, _tileSize) {
	this.rows = _rows;
	this.columns = _columns;
	this.map = [];
	this.inGrid = function(_row, _col) { return _row >= 0 && _row < this.rows && _col >= 0 && _col < this.columns; }

	for (row = 0; row < this.rows; row++) {
		this.map[row] = [];
		for (col = 0; col < this.columns; col++) {
			_tileType = EMPTY;
			//_tileType = CLAIM;
			//_tileType = DEADPATH;

			// the border of the initial grid must be set as PATH
			// first row, first column, last row and last column
			if (row == 0 || col == 0 || row == (this.rows - 1) || col == (this.columns - 1)) {
				_tileType = PATH;
			}

			this.map[row][col] = new Tile(col * _tileSize + _x, row * _tileSize + _y, _tileSize, row, col, _tileType);
		}
	}
}

var GRID = new Grid(0, 0, GRID_ROWS, GRID_COLS, CEL_HEIGHT);


function newImage(src, height, position, top, left, zIndex, alt) {
	var img = new Image();
	img.src = src;
	img.height = height;
	img.style.position = position;
	img.style.top = top;
	img.style.left = left;
	img.style.zIndex = zIndex;
	img.alt = alt;
	//img.onload = function() { positionImg(this); }
	return img;
}

var IS_GAME_OVER = false;
var GAME_OVER_IMG = newImage("./img/game_over_img.webp", 600, "relative", 0, 0, 1, "Game Over");
function gameOver() {
	IS_GAME_OVER = true;
	var td = document.getElementById("td_game");
	td.replaceChildren();
	td.appendChild(GAME_OVER_IMG);
}

var PAUSED_IMG = newImage("./img/paused.png", 120, "absolute", (((GRID_ROWS * CEL_HEIGHT) / 2) - (120 / 2) - 10), (((GRID_COLS * CEL_HEIGHT) / 2) - (250 / 2)), PAUSE_ZINDEX, "Game Paused");
PAUSED_IMG.id = "PausedImgModal";
PAUSED_IMG.style.visibility = "hidden";

var NEXT_LEVEL_IMG = newImage("./img/level_complete.png", 165, "absolute", (((GRID_ROWS * CEL_HEIGHT) / 2) - (165 / 2) - 10), (((GRID_COLS * CEL_HEIGHT) / 2) - (400 / 2)), PAUSE_ZINDEX, "Next Level");
NEXT_LEVEL_IMG.id = "NextLevelImgModal";
NEXT_LEVEL_IMG.style.visibility = "hidden";


function removeImmunity() {
	PLAYER.isImmune = false;
}

function Player(_tile) {
	this.tile = _tile;
	GRID.map[_tile.row][_tile.col].hasPlayer = true;
	this.images = ["./img/player_00.png", "./img/player_01.png"];
	this.imgIdx = 0;
	this.img = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, PLAYER_ZINDEX, "Player");
	this.img.id = "player_img";
	this.isClaiming = false;
	this.lives = 10;
	this.isImmune = false;
	this.immuneUntil = new Date();

	this.hit = function() {
		if (this.isImmune) {
			return;
		}
		this.lives--;
		updateLives(this.lives);
		if (this.lives > 0) {
			this.isImmune = true;
			var t = new Date();
			t.setSeconds(t.getSeconds() + 3);
			this.immuneUntil = t;
		} else {
			gameOver();
		}
	}
	this.getTile = function() { return this.tile; }
	this.hide = function() { this.img.style.visibility = "hidden"; }
	this.show = function() { this.img.style.visibility = "visible"; }
	this.setTile = function(_curr) {
		if (GRID.inGrid(_curr.row, _curr.col)) {
			GRID.map[this.tile.row][this.tile.col].hasPlayer = false;
			this.tile = _curr
			GRID.map[_curr.row][_curr.col].hasPlayer = true;
			this.img.style.top = _curr.y;
			this.img.style.left = _curr.x;
			if (this.tile.hasSparx || this.tile.hasQix) {
				this.hit();
			}
		}
	}
	this.nextImg = function() {
		this.imgIdx++;
		if (this.imgIdx >= this.images.length) {
			this.imgIdx = 0;
		}
		this.img.src = this.images[this.imgIdx];
		if (this.isImmune) {
			// if paused, keep extending the immunity
			if (IS_PAUSED) {
				this.immuneUntil = new Date(this.immuneUntil.getTime() + ANIMATION_INTERVAL);
			}

			if (this.immuneUntil < new Date()) {
				this.isImmune = false;
				this.img.style.filter = "invert(0)";
			} else {
				this.img.style.filter = "invert(100)";
			}
		}
	}
}

var PLAYER = new Player(GRID.map[GRID.rows - 1][GRID.columns / 2]);
function playerNextImg() {
	PLAYER.nextImg();
}
window.setInterval(playerNextImg, ANIMATION_INTERVAL);

function tailPop() {
	var t = PLAYER_TAIL.pop();
	if (PLAYER_TAIL.length == 0) {
		t.tileType = PATH;
	} else {
		t.tileType = EMPTY;
	}
	var img = document.getElementById("img_" + t.row + "_" + t.col);
	img.src = t.tileType.img;

	PLAYER.setTile(t);
}

async function breakPlayerTail() {
	wasPushing = false;
	IS_PAUSED = true;
	PLAYER.hit();

	while (PLAYER_TAIL.length > 0) {
		tailPop();
		await new Promise(resolve => setTimeout(resolve, 5));
	}

	IS_PAUSED = false;
}

function Qix(_tile) {
	this.tile = _tile;
	this.mid = _tile;
	this.tail = _tile;
	GRID.map[_tile.row][_tile.col].hasQix = true;
	this.images = ["./img/qix_00.png", "./img/qix_01.png", "./img/qix_02.png"];
	this.imgIdx = 0;
	this.img = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, QIX_ZINDEX, "Qix");
	this.img.id = "qix_img";
	this.imgMid = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, QIX_ZINDEX, "Qix");
	this.imgMid.id = "qix_img_mid";
	this.imgTail = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, QIX_ZINDEX, "Qix");
	this.imgTail.id = "qix_img_tail";
	this.velX = 0;
	this.velY = 0;
	this.tickCounter = 0;

	this.getTile = function() { return this.tile; }
	this.setTile = function(_curr) {
		if (GRID.inGrid(_curr.row, _curr.col)) {
			GRID.map[this.tile.row][this.tile.col].hasQix = false;
			this.tail = this.mid;
			this.mid = this.tile;
			this.tile = _curr
			GRID.map[_curr.row][_curr.col].hasQix = true;
			this.img.style.top = _curr.y;
			this.img.style.left = _curr.x;
			this.imgMid.style.top = this.mid.y;
			this.imgMid.style.left = this.mid.x;
			this.imgTail.style.top = this.tail.y;
			this.imgTail.style.left = this.tail.x;
		}
	}
	this.show = function() {
		this.img.style.visibility = "visible";
		this.imgMid.style.visibility = "visible";
		this.imgTail.style.visibility = "visible";
	}
	this.hide = function() {
		this.img.style.visibility = "hidden";
		this.imgMid.style.visibility = "hidden";
		this.imgTail.style.visibility = "hidden";
	}
	this.nextImg = function() {
		this.imgIdx++;
		if (this.imgIdx >= this.images.length) {
			this.imgIdx = 0;
		}
		this.img.src = this.images[this.imgIdx];
		this.imgMid.src = this.images[this.imgIdx];
		this.imgTail.src = this.images[this.imgIdx];
	}
	this.move = function() {
		if (IS_PAUSED || IS_GAME_OVER) {
			return;
		}
		this.tickCounter++;
		if (this.tickCounter >= 10) {
			this.tickCounter = 0;
			switch (Math.floor(Math.random() * 7)) {
				case 0: this.velX = 1; this.velY = 0; break;
				case 1: this.velX = -1; this.velY = 0; break;
				case 2: this.velX = 0; this.velY = 1; break;
				case 3: this.velX = 0; this.velY = -1; break;
				case 4: this.velX = 1; this.velY = 1; break;
				case 5: this.velX = -1; this.velY = -1; break;
				case 6: this.velX = 1; this.velY = -1; break;
				default: this.velX = -1; this.velY = 1;
			}
		}
		var newRow = this.tile.row + this.velY;
		var newCol = this.tile.col + this.velX;
		if (GRID.inGrid(newRow, newCol)) {
			var newTile = GRID.map[newRow][newCol];
			if (newTile.tileType != PATH) {
				this.setTile(newTile);
				if (this.getTile().tileType == PUSH) {
					breakPlayerTail();
				}
			} else {
				this.velY *= -1;
				this.velX *= -1;
				newRow = this.tile.row + this.velY;
				newCol = this.tile.col + this.velX;
				newTile = GRID.map[newRow][newCol];
				if (newTile.tileType != PATH) {
					this.setTile(newTile);
				}
			}
		}
	}
}

var QIX = new Qix(GRID.map[GRID.rows / 2][GRID.columns / 2]);
function qixMove() {
	QIX.nextImg();
	QIX.move();
}
window.setInterval(qixMove, ANIMATION_INTERVAL / 2);


function Sparx(_tile, _clockwise) {
	this.tile = _tile;
	this.prev = _tile;
	this.clockwise = _clockwise;
	GRID.map[_tile.row][_tile.col].hasSparx = true;
	this.images = ["./img/sparx_00.png", "./img/sparx_01.png"];
	this.imgIdx = 0;
	this.img = newImage(this.images[0], CEL_HEIGHT, "absolute", this.tile.y, this.tile.x, SPARX_ZINDEX, "Sparx");
	this.img.id = "sparx_img";
	this.canMove = false;

	this.getTile = function() { return this.tile; }
	this.setTile = function(_curr) {
		if (GRID.inGrid(_curr.row, _curr.col)) {
			GRID.map[this.tile.row][this.tile.col].hasSparx = false;
			this.prev = this.tile
			this.tile = _curr
			GRID.map[_curr.row][_curr.col].hasSparx = true;
			this.img.style.top = _curr.y;
			this.img.style.left = _curr.x; 
		}
	}
	this.hide = function() { this.img.style.visibility = "hidden"; }
	this.show = function() { this.img.style.visibility = "visible"; }
	this.nextImg = function() {
		this.imgIdx++;
		if (this.imgIdx >= this.images.length) {
			this.imgIdx = 0;
		}
		this.img.src = this.images[this.imgIdx];
	}
	this.move = function() {
		if (IS_PAUSED || IS_GAME_OVER) {
			return;
		}
		if (this.canMove) {
			// if first move
			if (this.prev.row == this.tile.row && this.prev.col == this.tile.col) {
				if (this.clockwise) {
					if (this.tile.row == 0) {
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (this.tile.col == 0) {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					}
				} else {
					if (this.tile.row == 0) {
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (this.tile.col == 0) {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					}
				}
			} else {
				// not first move
				if ((this.tile.col - this.prev.col) > 0) { // left to right
					if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == PATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == PATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == DEADPATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == DEADPATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					}
				} else if ((this.tile.row - this.prev.row) > 0) { // up to down
					if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == PATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == PATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == DEADPATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == DEADPATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					}
				} else if ((this.tile.col - this.prev.col) < 0) { // right to left
					if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == PATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == PATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == DEADPATH) { // down to up
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row + 1, this.tile.col) && GRID.map[this.tile.row + 1][this.tile.col].tileType == DEADPATH) { // up to down
						this.setTile(GRID.map[this.tile.row + 1][this.tile.col]);
					}
				} else { // down to up
					if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == PATH) {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == PATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == PATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					} else if (GRID.inGrid(this.tile.row - 1, this.tile.col) && GRID.map[this.tile.row - 1][this.tile.col].tileType == DEADPATH) {
						this.setTile(GRID.map[this.tile.row - 1][this.tile.col]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col + 1) && GRID.map[this.tile.row][this.tile.col + 1].tileType == DEADPATH) { // left to right
						this.setTile(GRID.map[this.tile.row][this.tile.col + 1]);
					} else if (GRID.inGrid(this.tile.row, this.tile.col - 1) && GRID.map[this.tile.row][this.tile.col - 1].tileType == DEADPATH) { // right to left
						this.setTile(GRID.map[this.tile.row][this.tile.col - 1]);
					}
				}
			}
		}
		if (this.getTile().hasPlayer) {
			PLAYER.hit();
		}
		this.canMove = !this.canMove;
	}
}

var SPARX1 = new Sparx(GRID.map[0][Math.floor(Math.random() * (GRID.columns - 2))], (Math.floor(Math.random() * 10) > 5) ? true : false);
var SPARX2 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][0], (Math.floor(Math.random() * 10) > 5) ? true : false);
var SPARX3 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][GRID.columns - 1], (Math.floor(Math.random() * 10) > 5) ? true : false);
//var sparxList = [SPARX1];
var sparxList = [SPARX1, SPARX2, SPARX3];
function sparxMove() {
	for (i = 0; i < sparxList.length; i++) {
		sparxList[i].nextImg();
		sparxList[i].move();
	}
}
window.setInterval(sparxMove, ANIMATION_INTERVAL * 1.0);


function pushIfEmpty(_row, _col) {
	if (GRID.map[_row][_col].tileType == EMPTY) {
		GRID.map[_row][_col].tileType = PUSH;
		var img = document.getElementById("img_" + _row + "_" + _col);
		img.src = PUSH.img;
		return true;
	}
	return false;
}

var VEL_L = 0;
var VEL_R = 0;
var VEL_U = 0;
var VEL_D = 0;

function unclaim(_tile) {
	var tiles = [];
	tiles.push(_tile);
	
	while (tiles.length > 0) {
		var t = tiles.pop();
		if (t.tileType == CLAIM) {
			t.tileType = EMPTY;
			if (GRID.inGrid(t.row + 1, t.col)) {
				tiles.push(GRID.map[t.row + 1][t.col]);
			}
			if (GRID.inGrid(t.row - 1, t.col)) {
				tiles.push(GRID.map[t.row - 1][t.col]);
			}
			if (GRID.inGrid(t.row, t.col + 1)) {
				tiles.push(GRID.map[t.row][t.col + 1]);
			}
			if (GRID.inGrid(t.row, t.col - 1)) {
				tiles.push(GRID.map[t.row][t.col - 1]);
			}

			if (GRID.inGrid(t.row + 1, t.col + 1)) {
				tiles.push(GRID.map[t.row + 1][t.col + 1]);
			}
			if (GRID.inGrid(t.row - 1, t.col + 1)) {
				tiles.push(GRID.map[t.row - 1][t.col + 1]);
			}
			if (GRID.inGrid(t.row + 1, t.col - 1)) {
				tiles.push(GRID.map[t.row + 1][t.col - 1]);
			}
			if (GRID.inGrid(t.row - 1, t.col - 1)) {
				tiles.push(GRID.map[t.row - 1][t.col - 1]);
			}
		} else if (t.tileType == DEADPATH) {
			t.tileType = PATH;
		}
	}
}

function updateGrid() {
	for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
		for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
			var img = document.getElementById("img_" + rowIdx + "_" + colIdx);
			img.src = GRID.map[rowIdx][colIdx].tileType.img;
		}
	}
}


function countEmpty() {
	var count = 0;
	for (var i = 0; i < GRID_ROWS; i++) {
		for (var j = 0; j < GRID_COLS; j++) {
			if (GRID.map[i][j].tileType == EMPTY || GRID.map[i][j].tileType == PATH) {
				count++;
			}
		}
	}
	return count;
}

function getClaimPercent() {
	return Math.floor((GRID_ROWS * GRID_COLS - countEmpty()) / (GRID_ROWS * GRID_COLS) * 100);
}

function updateLives(_lives) {
	document.getElementById("lives_text").textContent = _lives;
}

function updateLevel(_level) {
	document.getElementById("level_text").textContent = _level;
}

function updateClaimedPercent(_claimed) {
	document.getElementById("claimed_text").textContent = _claimed;
}

function updateGoal(_goal) {
	document.getElementById("goal_text").textContent = _goal;
}

async function clearGrid() {
	for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
		for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
			var img = document.getElementById("img_" + rowIdx + "_" + colIdx);
			img.src = CLAIM.img;
		}
		await new Promise(resolve => setTimeout(resolve, 20));
	}
}

function hideActors() {
	PLAYER.hide();
	QIX.hide();
	for (i = 0; i < sparxList.length; i++) {
		sparxList[i].hide();
	}
}

function showActors() {
	PLAYER.show();
	QIX.show();
	for (i = 0; i < sparxList.length; i++) {
		sparxList[i].show();
	}
}

var wasPushing = false;
async function claim() {
	for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
		for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
			if (GRID.map[rowIdx][colIdx].tileType == PATH || GRID.map[rowIdx][colIdx].tileType == PUSH) {
				GRID.map[rowIdx][colIdx].tileType = DEADPATH;
			} else if (GRID.map[rowIdx][colIdx].tileType == EMPTY) {
				GRID.map[rowIdx][colIdx].tileType = CLAIM;
			}
		}
	}
	unclaim(QIX.tile);
	updateGrid();
	var claimPercent = getClaimPercent();
	updateClaimedPercent(claimPercent);
	GIRLS.getSelectedGirl().getLevelImg(LEVELS.level).setMaxPercentage(claimPercent);
	if (claimPercent >= LEVELS.getCurrentLevel().goal) {
		GIRLS.getSelectedGirl().getLevelImg(LEVELS.level).revealed = true;
		IS_PAUSED = true; 
		LEVELS.nextLevel();
		hideActors();
		clearGrid();
		await new Promise(resolve => setTimeout(resolve, 5 * 1000)); // 5 seconds
		NEXT_LEVEL_IMG.style.visibility = "visible";
		await new Promise(resolve => setTimeout(resolve, 5 * 1000)); // 5 seconds
		showActors();
		if (LEVELS.finished) {
			displayGirls();
			girlModal.style.display = "block";
		} else {
			loadLevel();
		}
	}
}

function movePlayer() {
	if (IS_PAUSED || IS_GAME_OVER) {
		return;
	}

	VEL_R = 0;
	if (KEYS[39] || KEYS[68]) { // 39 = right / 68 = "D"
		VEL_R = 1;
	}

	VEL_L = 0;
	if (KEYS[37] || KEYS[65]) { // 37 = left / 65 = "A"
		VEL_L = -1;
	}

	VEL_U = 0;
	if (KEYS[38] || KEYS[87]) { // 38 = up / 87 = "W"
		VEL_U = -1;
	}

	VEL_D = 0;
	if (KEYS[40] || KEYS[83]) { // 40 = down / 83 = "S"
		VEL_D = 1;
	}

	PLAYER.isClaiming = false;
	if (KEYS[32]) { // space key
		PLAYER.isClaiming = true;
	}

	if (wasPushing && !PLAYER.isClaiming) {
		tailPop();
		if (PLAYER_TAIL.length == 0) {
			wasPushing = false;
			return;
		}
		return;
	}

	if (VEL_L != 0 || VEL_R != 0 || VEL_U != 0 || VEL_D != 0) {
		if (GRID.inGrid(PLAYER.getTile().row + VEL_U + VEL_D, PLAYER.getTile().col + VEL_L + VEL_R)) {
			//console.log("PLAYER.isClaiming: " + PLAYER.isClaiming)
			if (PLAYER.isClaiming) {
				if (wasPushing && GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PATH) {
					PLAYER.isClaiming = false;
					wasPushing = false;
					PLAYER_TAIL = [];
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
					claim();
					return;
				}
				if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PUSH
					|| GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == CLAIM
					|| GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == DEADPATH) {
					return;
				}
				if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == EMPTY) {
					wasPushing = true;
				}
				if ((((VEL_L + VEL_R) > 0) && ((VEL_U + VEL_D) > 0)) || (((VEL_L + VEL_R) > 0) && ((VEL_U + VEL_D) < 0))) { // diagonal move -> (right and dowm) or (right and up)
					pushIfEmpty(PLAYER.getTile().row, PLAYER.getTile().col + VEL_L + VEL_R);
					PLAYER_TAIL.push(GRID.map[PLAYER.getTile().row][PLAYER.getTile().col + VEL_L + VEL_R]);
				} else if ((((VEL_L + VEL_R) < 0) && ((VEL_U + VEL_D) > 0)) || (((VEL_L + VEL_R) < 0) && ((VEL_U + VEL_D) < 0))) { // diagonal move -> (left and dowm) or (left and up)
					pushIfEmpty(PLAYER.getTile().row, PLAYER.getTile().col + VEL_L + VEL_R);
					PLAYER_TAIL.push(GRID.map[PLAYER.getTile().row][PLAYER.getTile().col + VEL_L + VEL_R]);
				}
				if (pushIfEmpty(PLAYER.getTile().row + VEL_U + VEL_D, PLAYER.getTile().col + VEL_L + VEL_R)) {
					if (PLAYER.getTile().tileType == PATH || PLAYER.getTile().tileType == EMPTY) {
						PLAYER_TAIL.push(PLAYER.getTile());
					}
					if (PLAYER.getTile().tileType == EMPTY) {
						pushIfEmpty(PLAYER.getTile().row, PLAYER.getTile().col);
					}
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
					PLAYER_TAIL.push(PLAYER.getTile());
				} else if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PATH) {
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
				}
			} else { // not claiming, can only move to another PATH tile
				if (GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R].tileType == PATH) {
					PLAYER.setTile(GRID.map[PLAYER.getTile().row + VEL_U + VEL_D][PLAYER.getTile().col + VEL_L + VEL_R]);
				}
			}
		}
	}
}
window.setInterval(movePlayer, 1000 / 20);

function openURL(_url) {
	pauseGame(document.getElementById("btn_pause"));
	window.open(_url, "_blank").focus();
	pausePlayLeave(document.getElementById("btn_pause"));
}

function openPatreon() {
	openURL(LEVELS.girl.patreon);
}

function loadLevel() {
	// reseting elements
	GRID = new Grid(0, 0, GRID_ROWS, GRID_COLS, CEL_HEIGHT);
	var playerLives = PLAYER.lives;
	PLAYER = new Player(GRID.map[GRID.rows - 1][GRID.columns / 2]);
	PLAYER.lives = playerLives;
	QIX = new Qix(GRID.map[GRID.rows / 2][GRID.columns / 2]);
	SPARX1 = new Sparx(GRID.map[0][Math.floor(Math.random() * (GRID.columns - 2))], (Math.floor(Math.random() * 10) > 5) ? true : false);
	SPARX2 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][0], (Math.floor(Math.random() * 10) > 5) ? true : false);
	SPARX3 = new Sparx(GRID.map[Math.floor(Math.random() * (GRID.rows - 2))][GRID.columns - 1], (Math.floor(Math.random() * 10) > 5) ? true : false);
	sparxList = [SPARX1, SPARX2, SPARX3];
	PAUSED_IMG.style.visibility = "hidden";
	NEXT_LEVEL_IMG.style.visibility = "hidden";

	// updating UI
	updateLives(PLAYER.lives);
	updateLevel(LEVELS.level);
	updateClaimedPercent(0);
	updateGoal(LEVELS.getCurrentLevel().goal);
	document.getElementById("player_head_img").src = LEVELS.getAvatarImg();
	document.getElementById("player_head_img").title = LEVELS.avatar.getTitle();
	document.getElementById("girl_head_img").src = LEVELS.getGirlHead();
	document.getElementById("girl_head_img").title = LEVELS.girl.getTitle();
	if (LEVELS.girl.patreon != "") {
		document.getElementById("girl_head_img").onclick = openPatreon;
		document.getElementById("girl_head_img").classList.add("clickable");
	} else {
		document.getElementById("girl_head_img").onclick = null;
		document.getElementById("girl_head_img").classList.remove("clickable");
	}

	var td = document.getElementById("td_game");
	td.replaceChildren();
	var bgImg = newImage(LEVELS.getCurrentLevel().girlImg, 600, "relative", 0, 0, 1, "");
	bgImg.id = "BgImg";
	td.appendChild(bgImg);

	for (var rowIdx = 0; rowIdx < GRID.rows; rowIdx++) {
		for (var colIdx = 0; colIdx < GRID.columns; colIdx++) {
			var tile = GRID.map[rowIdx][colIdx];
			var celImg = newImage(tile.tileType.img, tile.pixels, "absolute", tile.y, tile.x, COVER_ZINDEX, "");
			celImg.id = "img_" + rowIdx + "_" + colIdx;
			td.appendChild(celImg);
		}
	}

	td.appendChild(PLAYER.img);
	td.appendChild(QIX.img);
	td.appendChild(QIX.imgMid);
	td.appendChild(QIX.imgTail);
	for (i = 0; i < sparxList.length; i++) {
		td.appendChild(sparxList[i].img);
	}

	td.appendChild(PAUSED_IMG);
	td.appendChild(NEXT_LEVEL_IMG);
	IS_PAUSED = false;
	IS_GAME_OVER = false;
}

function onLoad() {
	document.getElementById("AvatarModal").style.display = "block";
}

function pausePlayHover(img) {
	if (IS_PAUSED) {
		img.src = "./img/play_hover.png";
	} else {
		img.src = "./img/pause_hover.png";
	}
}

function pausePlayLeave(img) {
	if (IS_PAUSED) {
		img.src = "./img/play.png";
	} else {
		img.src = "./img/pause.png";
	}
}

function pauseGame(img) {
	IS_PAUSED = !IS_PAUSED;
	PAUSED_IMG.style.visibility = (IS_PAUSED ? "visible" : "hidden");
	pausePlayHover(img);
}

function startGame() {
	if (!confirm("Do you want to start a new game?")) {
		return;
	}
	IS_PAUSED = true;

	document.getElementById("btn_pause").src = "./img/pause.png";
	PLAYER = new Player(GRID.map[GRID.rows - 1][GRID.columns / 2]);
	onLoad();
}

function moveKeysLeave() {
	document.getElementById("movement_keys_img").src = "./img/movement_keys_0.png";
	document.getElementById("tr_pre_movement_text").style = "display:none";
	document.getElementById("tr_movement_text").style = "display:none";
}
function moveKeysOver() {
	document.getElementById("movement_keys_img").src = "./img/movement_keys_1.png";
	document.getElementById("tr_pre_movement_text").style = "display:";
	document.getElementById("tr_movement_text").style = "display:";
}

window.addEventListener("keydown", function (e) {
	//console.log("e.keyCode: " + e.keyCode)
    KEYS[e.keyCode] = true;
});

window.addEventListener("keyup", function (e) {
    KEYS[e.keyCode] = false;
});
</script>

<body bgcolor="BLACK" onload="onLoad()" id="html_body_id">
<table id="main_table">
<tbody>
<tr style="position: relative;">
	<td id="td_game" class="tops" style="position: relative;">
		<!--img width="900" height="600" id="BgImg" src="./img/empty_tile.png" title="Revealed"/-->
	</td>
	<td rowspan="3"><img align="center" width="5px" src="./img/empty_tile.png"/></td>
	<td rowspan="3" class="tops">
		<table>
			<tr>
				<td>
					<img align="center" width="202" id="LewdQix-Logo" src="./LewdQix-Logo.png" title="Lewd Qix"/>
				</td>
			</tr>
			<tr>
				<td>
					<img height="5px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td bgcolor="white" align="center">
					<table>
						<tr>
							<td><b style="font-family:'Calibri'">Lives: <span id="lives_text">10</span></b></td>
						</tr>
						<tr>
							<td><b style="font-family:'Calibri'">Level: <span id="level_text">1</span></b></td>
						</tr>
						<tr>
							<td><b style="font-family:'Calibri'">Claimed: <span id="claimed_text">0</span>%</b></td>
						</tr>
						<tr>
							<td><b style="font-family:'Calibri'">Claim Goal: <span id="goal_text">60</span>%</b></td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td>
					<img align="left" height="5px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td align="center">
					<img height="24px" id="btn_pause" class="clickable" src="./img/pause.png" title="Pause" onmouseover="pausePlayHover(this)" onmouseleave="pausePlayLeave(this)" onclick="pauseGame(this)"/>
					<img width="10px" src="./img/empty_tile.png"/>
					<img height="24px" id="btn_restart" class="clickable" src="./img/restart.png" title="Restart" onmouseover="this.src='./img/restart_hover.png'" onmouseleave="this.src='./img/restart.png'" onclick="startGame()"/>
				</td>
			</tr>
			<tr>
				<td>
					<img align="left" height="1px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td bgcolor="white" align="center" onmouseover="moveKeysOver()" onmouseleave="moveKeysLeave()" title="Movement Keys">
					<img align="left" height="5px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td bgcolor="white" align="center" onmouseover="moveKeysOver()" onmouseleave="moveKeysLeave()" title="Movement Keys">
					<img id="movement_keys_img" height="56" align="center" src="./img/movement_keys_0.png" title="Movement Keys"/>
					<img align="left" height="5px" src="./img/empty_tile.png"/>
					<img id="space_key_img" height="27" align="center" src="./img/space_key.png" title="Space Key"/><br/>
					<img align="left" height="5px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr id="tr_pre_movement_text" style="display:none">
				<td>
					<img align="left" height="5px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr id="tr_movement_text" style="display:none">
				<td bgcolor="white" align="center" title="Movement Keys">
					<table>
						<tr>
							<td align="center"><b style="font-family:'Calibri'; font-size:15px;">Use W, A, S, D, or the arrow<br/> keys to move the cursor.</b></td>
						</tr>
						<tr>
							<td>
								<img align="left" height="5px" src="./img/empty_tile.png"/>
							</td>
						</tr>
						<tr>
							<td align="center"><b style="font-family:'Calibri'; font-size:15px;">Keep the Space key pressed<br/> to capture.</b></td>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
				<td>
					<img align="left" height="5px" src="./img/empty_tile.png"/>
				</td>
			</tr>
			<tr>
				<td>
					<img align="center" width="202" src="./img/player_and_girl.png"/>
				</td>
			</tr>
			<tr>
				<td align="center">
					<img height="140" class="round" id="player_head_img" src="./img/empty_tile.png" title="Player"/>
					<img width="9px" src="./img/empty_tile.png"/>
					<img height="140" class="round" id="girl_head_img" src="./img/empty_tile.png" title="Girl"/>
				</td>
			</tr>
		</table>
	</td>
</tr>
<tr>
	<td><img align="left" height="5px" src="./img/empty_tile.png"/></td>
</tr>
<tr>
	<td class="clickable" align="center" bgcolor="white" onclick="openURL('https://www.patreon.com/grimagrima')"><a style="font-family:'Calibri'">https://www.patreon.com/grimagrima</a></td>
</tr>
</tbody>
</table>

<!-- The AvatarModal -->
<div id="AvatarModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
	<div class="sticky">
		<p align="center" class="round white"><img width="202" id="LewdQix-Logo" src="./LewdQix-Logo.png" title="Lewd Qix"/></p>
		<p align="center" class="round">Select your Avatar:</p>
	</div>
	<br>
	<table id="t_AvatarList" align="center">
		<tr>
			<td><img height='140' class='round clickable' src='./img/player_head_001.webp' title='Dylan' onclick='setAvatar(0)'/></td>
			<td class='round' bgcolor='gray' align='center' onclick='setAvatar(0)'><p>Dylan<br/>(Girl In Charge)</p></td>
			<td><img width='30px' src='./img/empty_tile.png'/></td>
			<td><img height="140" class="round clickable" src="./img/player_head_002.webp" title="Dylan2" onclick="setAvatar(1)"/></td>
			<td class="round" bgcolor="gray" align="center" onclick="setAvatar(1)"><p>Dylan2<br/>(Girl In Charge)</p></td>
			<td><img width="30px" src="./img/empty_tile.png"/></td>
			<td><img height="140" class="round clickable" src="./img/player_head_003.webp" title="Silhouette" onclick="setAvatar(2)"/></td>
			<td class="round" bgcolor="gray" align="center" onclick="setAvatar(2)"><p>Silhouette<br/></p></td>
			<td><img width="30px" src="./img/empty_tile.png"/></td>
		</tr>
		<tr><td><img height='30px' src='./img/empty_tile.png'/></td></tr>
	</table>
	<br>
  </div>
</div>

<!-- The GirlModal -->
<div id="GirlModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
	<div class="sticky">
		<p align="center" class="round white"><img width="202" id="LewdQix-Logo" src="./LewdQix-Logo.png" title="Lewd Qix"/></p>
		<p align="center" class="round">Select a Girl:</p>
	</div>
	<br>
	<table id="t_GirlList" align="center">
		<tr>
			<td><img height='140' class='round clickable' src='./img/girl_head_001.webp' title='Vanessa' onclick='setGirl(0)'/></td>
			<td class='round' bgcolor='gray' align='center' style="padding-left: 5px; padding-right: 5px;">
				<table><tr><td colspan='3' align="center"><p>Vanessa<br/>(Girl In Charge)</p></td></tr><tr><td align="center"><img src='./img/check_true.png'></td><td align="center"><img src='./img/check_true.png'></td><td align="center"><img src='./img/check_false.png'></td></tr></table>
			</td>
			<td><img width='30px' src='./img/empty_tile.png'/></td>
			<td><img height="140" class="round clickable" src="./img/girl_head_002.webp" title="Vanessa2" onclick="setGirl(1)"/></td>
			<td class="round" bgcolor="gray" align="center" style="padding:5px;">
				<table><tr><td colspan='3'><p>Vanessa2<br/>(Girl In Charge)</p></td></tr><tr><td><img src='./img/check_false.png'></td><td><img src='./img/check_false.png'></td><td><img src='./img/check_false.png'></td></tr></table>
			</td>
			<td><img width="30px" src="./img/empty_tile.png"/></td>
			<td><img height="140" class="round clickable" src="./img/girl_head_003.webp" title="Silhouette" onclick="setGirl(2)"/></td>
			<td class="round" bgcolor="gray" align="center">
				<table><tr><td colspan='3'><p>???<br/>(???)</p></td></tr><tr><td><img src='./img/check_false.png'></td><td><img src='./img/check_false.png'></td><td><img src='./img/check_false.png'></td></tr></table>
			</td>
			<td><img width="30px" src="./img/empty_tile.png"/></td>
		</tr>
		<tr><td><img height='30px' src='./img/empty_tile.png'/></td></tr>
	</table>
	<br>
  </div>
</div>

<!-- The ImgModal -->
<div id="ImgModal" class="modal2">
  <!-- Modal content -->
  <div class="modal-content">
	<table align="center">
		<tr>
			<td><img id="levelImgModal" align="center" height="600" src="./img/girl_001-01.webp"/></td>
			<td class="tops"><span class="close">&times;</span></td>
		</tr>
	</table>
  </div>
</div>

<script>
// Get the avatarModal
var avatarModal = document.getElementById("AvatarModal");

// Get the girlModal
var girlModal = document.getElementById("GirlModal");

// Get the ImgModal
var imgModal = document.getElementById("ImgModal");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  imgModal.style.display = "none";
}
function avatarImage(_i) {
	var img = new Image();
	img.src = AVATARS.avatars[_i].img;
	img.title = AVATARS.avatars[_i].getTitle();
	img.height = 140;
	img.classList.add("round");
	img.classList.add("clickable");
	img.onclick = function() { setAvatar(_i); }
	return img;
}

function girlImage(_i) {
	var img = new Image();
	img.src = GIRLS.girls[_i].img;
	img.title = GIRLS.girls[_i].getTitle();
	img.height = 140;
	img.classList.add("round");
	img.classList.add("clickable");
	img.onclick = function() { setGirl(_i); }
	return img;
}

function newEmptyImg() {
	var img = new Image();
	img.src = "./img/empty_tile.png";
	img.height = "30";
	img.width = "30";
	return img;
}

function displayAvatars() {
	var tAvatarList = document.getElementById("t_AvatarList");
	tAvatarList.replaceChildren();

	var rowCount = 0;
	var row1 = null;
	var row2 = null;
	var cell1 = null;
	var cell2 = null;
	var cell3 = null;
	var cell4 = null;

	for (var i = 0; i < AVATARS.avatars.length; i++) {
		if (((i + 1) % 3) == 1) {
			row1 = tAvatarList.insertRow(rowCount++);
		}
		cell1 = row1.insertCell();
		cell1.appendChild(avatarImage(i));

		cell2 = row1.insertCell();
		cell2.classList.add("round");
		cell2.style.backgroundColor = "gray";
		cell2.style.padding = "5px";
		cell2.align = "center";
		cell2.innerHTML = "<p>" + AVATARS.avatars[i].name + "<br/>(" + AVATARS.avatars[i].fromGame + ")</p>";

		cell3 = row1.insertCell();
		cell3.appendChild(newEmptyImg());

		if (((i + 1) % 3) == 0) {
			row2 = tAvatarList.insertRow(rowCount++);
			cell4 = row2.insertCell();
			cell4.appendChild(newEmptyImg());
		}
	}
}
displayAvatars();

function showUncoveredImg(_girl, _level) {
	var img = document.getElementById("levelImgModal");
	img.src = "./img/girl_" + GIRLS.girls[_girl].id + "-0" + _level + ".webp";
	imgModal.style.display = "block";
}

function getCheckImg(_girl, _level) {
	var img = new Image();
	if (GIRLS.girls[_girl].getLevelImg(_level).isRevealed()) {
		img.src = "./img/check_true.png";
		img.classList.add("clickable");
		img.onclick = function() { showUncoveredImg(_girl, _level); }
	} else {
		img.src = "./img/check_false.png";
		img.classList.remove("clickable");
	}
	img.title = "Level " + _level + " image max percentage: " + GIRLS.girls[_girl].getLevelImg(_level).maxPercentage + "%";
	return img;
}

function getGirlNameTable(_i) {
	var t = document.createElement('table');

	var r0 = t.insertRow(0);
	var cellName = r0.insertCell();
	cellName.align = "center";
	cellName.colSpan = 3;
	cellName.innerHTML = "<p>" + GIRLS.girls[_i].name + "<br/>(" + GIRLS.girls[_i].fromGame + ")</p>";

	var r1 = t.insertRow(1);
	for (var i = 1; i <= 3; i++) {
		var cell = r1.insertCell();
		cell.align = "center";
		cell.style.padding = "5px";
		cell.appendChild(getCheckImg(_i, i));
	}

	return t;
}

function displayGirls() {
	var tGirlList = document.getElementById("t_GirlList");
	tGirlList.replaceChildren();

	var rowCount = 0;
	var row1 = null;
	var row2 = null;
	var cell1 = null;
	var cell2 = null;
	var cell3 = null;
	var cell4 = null;

	for (var i = 0; i < GIRLS.girls.length; i++) {
		if (((i + 1) % 3) == 1) {
			row1 = tGirlList.insertRow(rowCount++);
		}
		cell1 = row1.insertCell();
		cell1.appendChild(girlImage(i));

		cell2 = row1.insertCell();
		cell2.classList.add("round");
		cell2.style.backgroundColor = "gray";
		cell2.style.padding = "5px";
		cell2.align = "center";
		cell2.appendChild(getGirlNameTable(i));

		cell3 = row1.insertCell();
		cell3.appendChild(newEmptyImg());

		if (((i + 1) % 3) == 0) {
			row2 = tGirlList.insertRow(rowCount++);
			cell4 = row2.insertCell();
			cell4.appendChild(newEmptyImg());
		}
	}
}
displayGirls();

function setAvatar(_seq) {
	AVATARS.selectedAvatar = _seq;
	displayGirls();
	avatarModal.style.display = "none";
	girlModal.style.display = "block";
}

function setGirl(_seq) {
	GIRLS.selectedGirl = _seq;
	girlModal.style.display = "none";
	LEVELS = new Levels(AVATARS.getSelectedAvatar(), GIRLS.getSelectedGirl());
	loadLevel();
}
</script>


</body>
</html>
